<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Security-Policy" content="connect-src 'self' data: https://api.cloudinary.com https://code.jquery.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://fonts.googleapis.com https://fonts.gstatic.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&family=Oswald:wght@400;700&family=Playfair+Display:wght@400;700&family=Cormorant+Garamond:wght@400;700&family=Dancing+Script:wght@400;700&family=Indie+Flower&family=Amatic+SC:wght@400;700&family=Permanent+Marker&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./lib/style.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        jQuery.fn.outerHTML = function() {
            return jQuery('<div />').append(this.eq(0).clone()).html();
        };
        Number.prototype.countDecimals = function () {
            if(Math.floor(this.valueOf()) === this.valueOf()) return 0;
            return this.toString().split(".")[1].length || 0; 
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.6.3/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/spectrum-colorpicker2/dist/spectrum.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/spectrum-colorpicker2/dist/spectrum.min.css">
    <script src="./vendor/grapick.min.js"></script>
    <link rel="stylesheet" href="./vendor/grapick.min.css">
    <script src="./vendor/undo-redo-stack.js"></script>
    <script src="./lib/core.js"></script>
    <script src="./lib/toolbar.js"></script>
    <script src="./lib/canvas.js"></script>
    <script src="./lib/shapes.js"></script>
    <script src="./lib/freeDrawSettings.js"></script>
    <script src="./lib/canvasSettings.js"></script>
    <script src="./lib/selectionSettings.js"></script>
    <script src="./lib/drawingLine.js"></script>
    <script src="./lib/drawingPath.js"></script>
    <script src="./lib/drawingText.js"></script>
    <script src="./lib/tip.js"></script>
    <script src="./lib/upload.js"></script>
    <script src="./lib/copyPaste.js"></script>
    <script src="./lib/utils.js"></script>
    <script src="./lib/zoom.js"></script>
    <script src="./lib/saveInBrowser.js"></script>
    <link rel="stylesheet" href="./zoom-fix.css">
</head>
<body>
    <div id="image-editor-container"></div>
    <script>
        try {
            const buttons = [
                'select', 'shapes', 'draw', 'line', 'path', 'textbox', 
                'upload', 'background', 'undo', 'redo', 'save', 'download', 'clear', 'back', 'task-info'
            ];

            var imgEditor = new ImageEditor('#image-editor-container', buttons, []);
            
            // Override save to communicate with parent
            const originalSave = document.querySelector('#save');
            
            if (originalSave) {
                originalSave.addEventListener('click', () => {
                    const dataURL = imgEditor.canvas.toDataURL('image/png');
                    window.parent.postMessage('SAVE:' + dataURL, '*');
                });
            }
            
            // Handle canvas JSON requests and loading
            window.addEventListener('message', (event) => {
                if (event.data === 'GET_CANVAS_JSON') {
                    const canvasData = imgEditor.getCanvasJSON();
                    window.parent.postMessage('CANVAS_JSON:' + JSON.stringify(canvasData), '*');
                } else if (event.data && event.data.type === 'LOAD_CANVAS') {
                    try {
                        imgEditor.setCanvasJSON(event.data.data);
                    } catch (error) {
                        console.error('Failed to load canvas data:', error);
                    }
                }
            });
            
        } catch (error) {
            console.error('Failed to initialize editor:', error);
        }
    </script>
</body>
</html>