<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Security-Policy" content="connect-src 'self' data: https://api.cloudinary.com https://code.jquery.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net">
    <link rel="stylesheet" href="./lib/style.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        jQuery.fn.outerHTML = function() {
            return jQuery('<div />').append(this.eq(0).clone()).html();
        };
        Number.prototype.countDecimals = function () {
            if(Math.floor(this.valueOf()) === this.valueOf()) return 0;
            return this.toString().split(".")[1].length || 0; 
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.6.3/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/spectrum-colorpicker2/dist/spectrum.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/spectrum-colorpicker2/dist/spectrum.min.css">
    <script src="./vendor/grapick.min.js"></script>
    <link rel="stylesheet" href="./vendor/grapick.min.css">
    <script src="./vendor/undo-redo-stack.js"></script>
    <script src="./lib/core.js"></script>
    <script src="./lib/toolbar.js"></script>
    <script src="./lib/canvas.js"></script>
    <script src="./lib/shapes.js"></script>
    <script src="./lib/freeDrawSettings.js"></script>
    <script src="./lib/canvasSettings.js"></script>
    <script src="./lib/selectionSettings.js"></script>
    <script src="./lib/drawingLine.js"></script>
    <script src="./lib/drawingPath.js"></script>
    <script src="./lib/drawingText.js"></script>
    <script src="./lib/tip.js"></script>
    <script src="./lib/upload.js"></script>
    <script src="./lib/copyPaste.js"></script>
    <script src="./lib/utils.js"></script>
    <script src="./lib/zoom.js"></script>
    <script src="./lib/saveInBrowser.js"></script>
    <link rel="stylesheet" href="./zoom-fix.css">
</head>
<body>
    <div id="image-editor-container"></div>
    <script>
        try {
            const buttons = [
                'select', 'shapes', 'draw', 'line', 'path', 'textbox', 
                'upload', 'background', 'undo', 'redo', 'save', 'download', 'clear'
            ];

            var imgEditor = new ImageEditor('#image-editor-container', buttons, []);
            
            // Load initial canvas data if provided
            const urlParams = new URLSearchParams(window.location.search);
            const canvasData = urlParams.get('canvasData');
            if (canvasData) {
                try {
                    imgEditor.setCanvasJSON(canvasData);
                } catch (error) {
                    console.error('Failed to load canvas data:', error);
                }
            }
            
            // Override save and download to communicate with parent
            const originalSave = document.querySelector('#save');
            const originalDownload = document.querySelector('#download');
            
            if (originalSave) {
                originalSave.addEventListener('click', () => {
                    const dataURL = imgEditor.canvas.toDataURL('image/png');
                    window.parent.postMessage('SAVE:' + dataURL, '*');
                });
            }
            
            if (originalDownload) {
                originalDownload.addEventListener('click', () => {
                    const canvas = imgEditor.canvas;
                    const dataURL = canvas.toDataURL('image/png');
                    window.parent.postMessage('EXPORT:' + dataURL, '*');
                });
            }
            
            // Handle canvas JSON requests
            window.addEventListener('message', (event) => {
                if (event.data === 'GET_CANVAS_JSON') {
                    const canvasData = imgEditor.getCanvasJSON();
                    window.parent.postMessage('CANVAS_JSON:' + JSON.stringify(canvasData), '*');
                }
            });
            
        } catch (error) {
            console.error('Failed to initialize editor:', error);
        }
    </script>
</body>
</html>