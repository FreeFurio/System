import e from"react";import{observer as t}from"mobx-react-lite";import o from"konva";import{TextElement as n}from"./text-element.js";import{ImageElement as r}from"./image-element.js";import{HTMLElement as i}from"./html-element.js";import{LineElement as m}from"./line-element.js";import{VideoElement as l}from"./video-element.js";import{FigureElement as s}from"./figure-element.js";import{GifElement as a}from"./gif-element.js";import{Group as c}from"react-konva";import{Highlighter as f}from"./highlighter.js";import{forEveryChild as p}from"../model/group-model.js";import{flags as d}from"../utils/flags.js";const u={text:n,image:r,svg:r,line:m,video:l,figure:s,group:t(t=>{const{element:o,store:n}=t,{children:r}=o,i=o.selectable||"admin"===n.role;return e.createElement(c,{opacity:o.opacity,listening:i,hideInExport:!o.showInExport},r.map(o=>e.createElement(h,Object.assign({},t,{key:o.id,store:n,element:o}))))}),gif:a};export function registerShapeComponent(e,t){u[e]=t}const g=(e,t)=>{const n=[];p(e,e=>{"group"!==e.type&&n.push(e.a)});const r=[];n.forEach(e=>{const t=[{x:0,y:0},{x:0+e.width,y:0},{x:0+e.width,y:0+e.height},{x:0,y:0+e.height}],n=new o.Transform;n.translate(e.x,e.y),n.rotate(o.Util.degToRad(e.rotation)),t.forEach(e=>{const t=n.point(e);r.push(t)})});const i=new o.Transform;i.rotate(-o.Util.degToRad(t));let m=1/0,l=1/0,s=-1/0,a=-1/0;r.forEach(e=>{const t=i.point(e);m=Math.min(m,t.x),l=Math.min(l,t.y),s=Math.max(s,t.x),a=Math.max(a,t.y)}),i.invert();const c=i.point({x:m,y:l});return{x:c.x,y:c.y,width:s-m,height:a-l,rotation:t}},h=t(t=>{const{element:n,store:r}=t,[m,l]=e.useState(!1),s=r.selectedElements.indexOf(n)>=0&&n.selectable,a="group"===n.parent.type,c=(t=>{const[n,r]=e.useState(null);return e.useEffect(()=>{const e=setTimeout(()=>{const e=t.page.id,n=o.stages.find(t=>t.getAttr("pageId")===e);n||console.error("No stage is found for element",t.id),r(n)});return()=>clearTimeout(e)},[t.id]),n})(n),p=null==c?void 0:c.findOne("Transformer");e.useEffect(()=>{if(c){const e=e=>{const t=e.target.findAncestor(".element",!0),o=r.getElementById(null==t?void 0:t.id()),i=null==o?void 0:o.top,m=null==i?void 0:i.id;l(m===n.id)};c.on("mouseover",e);const t=()=>{l(!1)};return c.on("mouseleave",t),()=>{c.off("mouseover",e),c.off("mouseleave",t)}}},[c]);let h=u[t.element.type];return"text"===t.element.type&&d.htmlRenderEnabled&&(h=i),t.element.visible?h?e.createElement(e.Fragment,null,e.createElement(h,Object.assign({},t)),(m||s)&&!a&&e.createElement(f,{element:"group"===n.type?{a:g(n,(null==p?void 0:p.rotation())||0)}:n})):(console.error("Can not find component for "+t.element.type),null):null});export default h;