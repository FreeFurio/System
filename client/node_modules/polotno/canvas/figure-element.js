import e from"react";import{observer as t}from"mobx-react-lite";import{Group as a,Rect as r,Path as s}from"react-konva";import{subTypeToPathDataFunc as o}from"../utils/figure-to-svg.js";import{isTouchDevice as i}from"../utils/screen.js";import{useColor as n}from"./use-color.js";const h={};export const FigureElement=t(({element:l,store:c})=>{const d=l.selectable||"admin"===c.role,g=i(),m=c.selectedShapes.indexOf(l)>=0&&l.selectable,p=Math.min(l.strokeWidth,l.width/2,l.height/2),f=Math.max(0,Math.min(l.width/2,l.height/2,l.cornerRadius)),w=n(l,l.a.fill,"fill"),u=Object.assign(Object.assign({width:l.a.width,height:l.a.height},w),{cornerRadius:f,opacity:l.animated("opacity"),shadowEnabled:l.shadowEnabled,shadowBlur:l.shadowBlur,shadowOffsetX:l.shadowOffsetX,shadowOffsetY:l.shadowOffsetY,shadowColor:l.shadowColor,shadowOpacity:l.shadowOpacity,preventDefault:!g||m,hideInExport:!l.showInExport}),b=n(l,l.stroke,"stroke"),y=Object.assign(Object.assign({visible:p>0,x:p/2,y:p/2,width:l.a.width-p,height:l.a.height-p},b),{strokeWidth:p,cornerRadius:Math.max(0,f-p),dash:l.dash.map(e=>e*p),opacity:l.animated("opacity"),hideInExport:!l.showInExport,listening:!1}),x=(E=l.subType,h[E]||(h[E]=(k=o(E),t(({element:t,fillProps:o,strokeProps:i})=>{let n=k({width:t.a.width,height:t.a.height,cornerRadius:t.cornerRadius}),h=1,l=1;"string"!=typeof n&&(h=n.scaleX,l=n.scaleY,n=n.path);const c=e.useRef(null);return e.createElement(e.Fragment,null,e.createElement(r,{width:t.width,height:t.height,fill:"transparent"}),e.createElement(s,Object.assign({},o,{ref:c,data:n,scaleX:h,scaleY:l})),e.createElement(a,{clipFunc:e=>{const t=c.current;if(t){var a=t.dataArray;e.beginPath();for(var r=0;r<a.length;r++){var s=a[r].command,o=a[r].points;switch(s){case"L":e.lineTo(o[0],o[1]);break;case"M":e.moveTo(o[0],o[1]);break;case"C":e.bezierCurveTo(o[0],o[1],o[2],o[3],o[4],o[5]);break;case"Q":e.quadraticCurveTo(o[0],o[1],o[2],o[3]);break;case"A":var i=o[0],n=o[1],h=o[2],l=o[3],d=o[4],g=o[5],m=o[6],p=o[7],f=h>l?h:l,w=h>l?1:h/l,u=h>l?l/h:1;e.translate(i,n),e.rotate(m),e.scale(w,u),e.arc(0,0,f,d,d+g,1-p),e.scale(1/w,1/u),e.rotate(-m),e.translate(-i,-n);break;case"z":e.closePath()}}}},scaleX:h,scaleY:l},e.createElement(s,Object.assign({},i,{x:0,y:0,data:n,strokeWidth:2*i.strokeWidth,dash:i.dash.map(e=>e)}))))}))),h[E]||a);var E,k;return e.createElement(e.Fragment,null,e.createElement(a,{id:l.id,x:l.a.x,y:l.a.y,rotation:l.a.rotation,opacity:l.a.opacity,listening:d,draggable:g?l.draggable&&m:l.draggable,name:"element",onDragMove:e=>{l.set({x:e.target.x(),y:e.target.y()})},onDragEnd:e=>{l.set({x:e.target.x(),y:e.target.y()})},onTransform:e=>{const t=e.target.scale();e.target.scaleX(1),e.target.scaleY(1),l.set({width:l.width*t.x,height:l.height*t.y,x:e.target.x(),y:e.target.y(),rotation:e.target.rotation()})}},e.createElement(x,{element:l,fillProps:u,strokeProps:y})))});