import e from"react";import{observer as t}from"mobx-react-lite";import{autorun as r}from"mobx";import{Image as a,Group as i,Rect as n,Arc as o,Text as h}from"react-konva";import d from"konva";import{parseGIF as s,decompressFrames as c}from"gifuct-js";import{useCornerRadiusAndCrop as l}from"./video-element.js";import{useImageLoader as g}from"./image-element.js";import{applyFilter as m}from"./apply-filters.js";import{useFadeIn as f}from"./use-fadein.js";import{isTouchDevice as u}from"../utils/screen.js";function p(e,t,r){const a=t.getContext("2d"),i=r.getContext("2d");if(!a||!i){return}2===e.disposalType&&a.clearRect(0,0,t.width,t.height),r.width=e.width,r.height=e.height;const n=i.createImageData(e.width,e.height);n.data.set(e.patch),i.putImageData(n,0,0),a.drawImage(r,e.left,e.top)}const w=t(({element:t})=>{const r=Math.min(30,t.width/4,t.height/4),a=e.useRef(null);return e.useEffect(()=>{const e=a.current;if(!e){return}const t=new d.Animation(t=>{e.rotate(((null==t?void 0:t.timeDiff)||0)/2)},e.getLayer());return t.start(),()=>{t.stop()}},[]),e.createElement(i,{x:t.a.x,y:t.a.y,rotation:t.a.rotation,listening:!1,opacity:t.a.opacity,hideInExport:!t.showInExport},e.createElement(n,{width:t.width,height:t.height,fill:"rgba(124, 173, 212, 0.8)"}),e.createElement(o,{ref:a,x:t.width/2,y:t.height/2,fill:"white",outerRadius:Math.abs(r),innerRadius:Math.max(1,r-5),angle:270}))}),y=t(({element:t})=>{const r=Math.max(10,Math.min(30,t.width/22));return e.createElement(i,{x:t.a.x,y:t.a.y,rotation:t.a.rotation,listening:!1,opacity:t.a.opacity,hideInExport:!t.showInExport},e.createElement(n,{width:t.width,height:t.height,fill:"rgba(223, 102, 102, 0.8)"}),e.createElement(h,{text:"Cannot load the GIF...",fontSize:r,width:t.width,height:t.height,align:"center",fill:"white",verticalAlign:"middle",padding:5}))});export const GifElement=t(({element:t,store:i})=>{var o;const[h,x]=e.useState(!1),E=i.selectedShapes.indexOf(t)>=0&&t.selectable,b=e.useRef(null),v=e.useRef(),[I,S,M,R]=function(t){const[r,a]=e.useState([]),[i,n]=e.useState(0),[o,h]=e.useState("loading"),[d,l]=e.useState({width:0,height:0});return e.useEffect(()=>{(async()=>{try{const e=await fetch(t),r=await e.arrayBuffer(),i=s(r),o=c(i,!0),d=i.lsd.width,g=i.lsd.height;l({width:d,height:g});const m=o.map(e=>({patch:new Uint8ClampedArray(e.patch),delay:e.delay,width:e.dims.width,height:e.dims.height,left:e.dims.left,top:e.dims.top,disposalType:e.disposalType})),f=m.reduce((e,t)=>e+t.delay,0);a(m),n(f),h("loaded")}catch(e){console.error("Failed to load GIF:",e),h("failed")}})()},[t]),[r,i,d,o]}(t.src);g(R,t.src,t.id),e.useEffect(()=>(v.current=document.createElement("canvas"),()=>{v.current&&d.Util.releaseCanvas(v.current)}),[]),e.useEffect(()=>{if("loaded"===R&&v.current&&(v.current.width=M.width,v.current.height=M.height,I.length>0)){const e=v.current.getContext("2d");if(e){e.clearRect(0,0,M.width,M.height);const t=document.createElement("canvas");p(I[0],v.current,t)}}},[M,R,I]),e.useEffect(()=>{if(!I.length||!v.current){return}const e=v.current;e.width=M.width,e.height=M.height;const a=document.createElement("canvas"),n=e.getContext("2d");n&&n.clearRect(0,0,e.width,e.height);let o=-1;p(I[0],e,a),D(),o=0;const h=t=>{const r=(e=>{const t=e%S;let r=0;for(let a=0;a<I.length;a++){if(r+=I[a].delay,r>t){return a}}return 0})(t);r!==o&&(p(I[r],e,a),D(),b.current.getLayer().draw(),o=r)};if(i.isPlaying||t.page._exportingOrRendering){return r(()=>{h(i.currentTime-t.page.startTime)})}{const e=window.setInterval(()=>{h(i.currentTime||performance.now())},16);return()=>{clearInterval(e)}}},[i.isPlaying,I,S,t.page._exportingOrRendering]),e.useEffect(()=>{S&&i.history.ignore(()=>{t.set({duration:S})})},[S]);let{cropX:C,cropY:T,cropWidth:O,cropHeight:z}=t;"loaded"!==R&&(C=T=0,O=z=1);const X={x:M.width*C,y:M.height*T,width:M.width*O,height:M.height*z},Y=null!==(o=t.cornerRadius)&&void 0!==o?o:0,[j,D]=l(t,v.current,X,i._elementsPixelRatio,Y,h||t._cropModeEnabled);e.useLayoutEffect(()=>{if(!h&&!t._cropModeEnabled&&b.current){return m(b.current,t),r(()=>{m(b.current,t)},{delay:100})}},[v.current,h,O,z,t._cropModeEnabled,M.width,M.height]);const _="loading"===R,k="failed"===R,F=_||k?0:t.a.opacity;f(b,F);const A=t.selectable||"admin"===i.role,B=u();return e.createElement(e.Fragment,null,_&&e.createElement(w,{element:t}),k&&e.createElement(y,{element:t}),e.createElement(a,{ref:b,name:"element",id:t.id,image:j,x:t.a.x,y:t.a.y,width:t.a.width||1,height:t.a.height||1,rotation:t.a.rotation,opacity:F,shadowEnabled:t.shadowEnabled,shadowBlur:t.shadowBlur,shadowOffsetX:t.shadowOffsetX,shadowOffsetY:t.shadowOffsetY,shadowColor:t.shadowColor,shadowOpacity:t.shadowOpacity,customCrop:X,listening:A,draggable:B?t.draggable&&E:t.draggable,preventDefault:!B||E,hideInExport:!t.showInExport,onDragMove:e=>{t.set({x:e.target.x(),y:e.target.y()})},onDragEnd:e=>{t.set({x:e.target.x(),y:e.target.y()})},onTransformStart:()=>x(!0),onTransform:e=>{const r=e.currentTarget,a=Math.abs(r.scaleX()-1)<1e-7?1:r.scaleX(),i=Math.abs(r.scaleY()-1)<1e-7?1:r.scaleY();r.scaleX(1),r.scaleY(1),t.set({x:r.x(),y:r.y(),width:r.width()*a,height:r.height()*i,rotation:r.rotation()})},onTransformEnd:()=>x(!1)}),e.createElement(n,{x:t.a.x,y:t.a.y,width:Math.max(t.a.width-t.borderSize,0),height:Math.max(t.a.height-t.borderSize,0),opacity:F,offsetX:-t.borderSize/2,offsetY:-t.borderSize/2,stroke:t.borderColor,strokeWidth:t.borderSize,listening:!1,visible:!!t.borderSize,rotation:t.rotation,cornerRadius:Math.max(0,Y-t.borderSize),hideInExport:!t.showInExport}))});