import e from"quill";import t from"dompurify";const i=e.import("modules/clipboard"),o=e.import("delta");class s extends i{constructor(e,t){super(e,t),this.allowed=t.allowed,this.keepSelection=t.keepSelection,this.substituteBlockElements=t.substituteBlockElements,this.magicPasteLinks=t.magicPasteLinks,this.hooks=t.hooks}onCapturePaste(i){var s,a,n,l,u,d,r,h,c,L,A;i.preventDefault();const p=this.quill.getSelection();let f,S,T;i.clipboardData&&i.clipboardData.getData||!window.clipboardData||!window.clipboardData.getData?(f=i.clipboardData.getData("text/plain"),S=i.clipboardData.getData("text/html"),T=null===(a=null===(s=i.clipboardData)||void 0===s?void 0:s.items)||void 0===a?void 0:a[0]):f=window.clipboardData.getData("Text");let E=(new o).retain(p.index).delete(p.length);const b=this.getDOMPurifyOptions();let D=!1,k=f;if(!S&&b.ALLOWED_TAGS.includes("a")&&this.isURL(f)&&p.length>0&&this.magicPasteLinks){k=this.quill.getText(p.index,p.length),E=E.insert(k,{link:f})}else if(!S&&b.ALLOWED_TAGS.includes("img")&&T&&"file"===T.kind&&T.type.match(/^image\//i)){const e=T.getAsFile(),t=new FileReader;t.onload=e=>{this.quill.insertEmbed(p.index,"image",e.target.result),this.keepSelection||this.quill.setSelection(p.index+1)},t.readAsDataURL(e)}else{S||(D=!0,S=k),"function"==typeof(null===(n=this.hooks)||void 0===n?void 0:n.beforeSanitizeElements)&&t.addHook("beforeSanitizeElements",this.hooks.beforeSanitizeElements),"function"==typeof(null===(l=this.hooks)||void 0===l?void 0:l.uponSanitizeElement)&&t.addHook("uponSanitizeElement",this.hooks.uponSanitizeElement),"function"==typeof(null===(u=this.hooks)||void 0===u?void 0:u.afterSanitizeElements)&&t.addHook("afterSanitizeElements",this.hooks.afterSanitizeElements),"function"==typeof(null===(d=this.hooks)||void 0===d?void 0:d.beforeSanitizeAttributes)&&t.addHook("beforeSanitizeAttributes",this.hooks.beforeSanitizeAttributes),"function"==typeof(null===(r=this.hooks)||void 0===r?void 0:r.uponSanitizeAttribute)&&t.addHook("uponSanitizeAttribute",this.hooks.uponSanitizeAttribute),"function"==typeof(null===(h=this.hooks)||void 0===h?void 0:h.afterSanitizeAttributes)&&t.addHook("afterSanitizeAttributes",this.hooks.afterSanitizeAttributes),"function"==typeof(null===(c=this.hooks)||void 0===c?void 0:c.beforeSanitizeShadowDOM)&&t.addHook("beforeSanitizeShadowDOM",this.hooks.beforeSanitizeShadowDOM),"function"==typeof(null===(L=this.hooks)||void 0===L?void 0:L.uponSanitizeShadowNode)&&t.addHook("uponSanitizeShadowNode",this.hooks.uponSanitizeShadowNode),"function"==typeof(null===(A=this.hooks)||void 0===A?void 0:A.afterSanitizeShadowDOM)&&t.addHook("afterSanitizeShadowDOM",this.hooks.afterSanitizeShadowDOM),D?(k=t.sanitize(S,b),E=E.insert(k)):(!1!==this.substituteBlockElements?(S=this.substitute(S,b),k=S.innerHTML):k=t.sanitize(S,b),E=E.concat(this.convert({html:k})))}this.quill.updateContents(E,e.sources.USER),D||(E=this.convert({html:k})),this.keepSelection?this.quill.setSelection(p.index,E.length(),e.sources.SILENT):this.quill.setSelection(p.index+E.length(),e.sources.SILENT),this.quill.scrollSelectionIntoView(),t.removeAllHooks()}getDOMPurifyOptions(){var e,t,i;let o={};if((null===(e=this.allowed)||void 0===e?void 0:e.tags)&&(o.ALLOWED_TAGS=this.allowed.tags),(null===(t=this.allowed)||void 0===t?void 0:t.attributes)&&(o.ALLOWED_ATTR=this.allowed.attributes),void 0===o.ALLOWED_TAGS||void 0===o.ALLOWED_ATTR){let e=!1;void 0===o.ALLOWED_TAGS&&(e=!0,o.ALLOWED_TAGS=["p","br","span"]);let t=!1;void 0===o.ALLOWED_ATTR&&(t=!0,o.ALLOWED_ATTR=["class"]);const s=this.quill.getModule("toolbar");null===(i=null==s?void 0:s.controls)||void 0===i||i.forEach(i=>{switch(i[0]){case"bold":e&&(o.ALLOWED_TAGS.push("b"),o.ALLOWED_TAGS.push("strong"));break;case"italic":e&&(o.ALLOWED_TAGS.push("i"),o.ALLOWED_TAGS.push("em"));break;case"underline":e&&o.ALLOWED_TAGS.push("u");break;case"strike":e&&o.ALLOWED_TAGS.push("s");break;case"color":case"background":t&&o.ALLOWED_ATTR.push("style");break;case"script":e&&("super"===i[1].value?o.ALLOWED_TAGS.push("sup"):"sub"===i[1].value&&o.ALLOWED_TAGS.push("sub"));break;case"header":if(e){const e=e=>{"1"===e?o.ALLOWED_TAGS.push("h1"):"2"===e?o.ALLOWED_TAGS.push("h2"):"3"===e?o.ALLOWED_TAGS.push("h3"):"4"===e?o.ALLOWED_TAGS.push("h4"):"5"===e?o.ALLOWED_TAGS.push("h5"):"6"===e&&o.ALLOWED_TAGS.push("h6")};i[1].value?e(i[1].value):i[1].options&&i[1].options.length&&[].forEach.call(i[1].options,t=>{t.value&&e(t.value)})}break;case"code-block":e&&o.ALLOWED_TAGS.push("pre"),t&&o.ALLOWED_ATTR.push("spellcheck");break;case"list":e&&("ordered"===i[1].value?o.ALLOWED_TAGS.push("ol"):"bullet"===i[1].value&&o.ALLOWED_TAGS.push("ul"),o.ALLOWED_TAGS.push("li"));break;case"link":e&&o.ALLOWED_TAGS.push("a"),t&&(o.ALLOWED_ATTR.push("href"),o.ALLOWED_ATTR.push("target"),o.ALLOWED_ATTR.push("rel"));break;case"image":e&&o.ALLOWED_TAGS.push("img"),t&&(o.ALLOWED_ATTR.push("src"),o.ALLOWED_ATTR.push("title"),o.ALLOWED_ATTR.push("alt"));break;case"video":e&&o.ALLOWED_TAGS.push("iframe"),t&&(o.ALLOWED_ATTR.push("frameborder"),o.ALLOWED_ATTR.push("allowfullscreen"),o.ALLOWED_ATTR.push("src"));break;case"blockquote":e&&o.ALLOWED_TAGS.push(i[0])}})}return o}substitute(e,i){let o;const s=["h1","h2","h3","h4","h5","h6"],a=["p","div","section","article","fieldset","address","aside","blockquote","canvas","dl","figcaption","figure","footer","form","header","main","nav","noscript","ol","pre","table","tfoot","ul","video"],n=["li","dt","dd","hr"];t.addHook("uponSanitizeElement",(e,t,l)=>{let u=0;for(;!o&&u<3;){i.ALLOWED_TAGS.includes(a[u])&&(o=a[u]),++u}if(o&&e.tagName&&!i.ALLOWED_TAGS.includes(e.tagName.toLowerCase())){const t=e.tagName.toLowerCase();s.includes(t)?e.innerHTML=`<${o}><b>${e.innerHTML}</b></${o}>`:a.includes(t)?e.innerHTML=`<${o}>${e.innerHTML}</${o}>`:n.includes(t)&&(e.innerHTML=`${e.innerHTML}<br>`)}}),e=t.sanitize(e,Object.assign(Object.assign({},i),{RETURN_DOM:!0,WHOLE_DOCUMENT:!1})),t.removeAllHooks();const l=e=>{const t=document.createElement(e.tagName.toLowerCase()),i=e.attributes;return i.length&&Array.from(i).forEach(e=>t.setAttribute(e.nodeName,e.value)),t};let u=0;const d=(e,t)=>{for(t(e,u),e=u<=1?e.firstChild:void 0;e;){++u,d(e,t),e=e.nextSibling}--u};let r;const h=document.createElement("body");return d(e,(e,t)=>{if(1===t){if(e.tagName&&a.includes(e.tagName.toLowerCase())){r&&(r=void 0);const t=l(e);t.innerHTML=e.innerHTML,h.appendChild(t)}else if(void 0===r&&(r=document.createElement(o),h.appendChild(r)),e.tagName){const t=l(e);e.innerHTML&&(t.innerHTML=e.innerHTML),r.appendChild(t)}else{const t=document.createTextNode(e.textContent);r.appendChild(t)}}}),h}isURL(e){return!!/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/isu.test(e)}}export function registerQuillPasteSmart(e){e.register("modules/clipboard",s,!0)}