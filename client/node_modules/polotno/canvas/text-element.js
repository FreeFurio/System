import t from"react";import{observer as e}from"mobx-react-lite";import{Group as n,Path as o,Text as r}from"react-konva";import{Html as i}from"react-konva-utils";import{autorun as a}from"mobx";import l from"konva";import{parsePath as s,roundCommands as c}from"svg-round-corners";import{useColor as d}from"./use-color.js";import{incrementLoader as h}from"../utils/loader.js";import{isFontLoaded as u}from"../utils/fonts.js";import{flags as f}from"../utils/flags.js";import{removeTags as g}from"../utils/text.js";import{applyFilter as m}from"./apply-filters.js";import{useFadeIn as p}from"./use-fadein.js";import{isTouchDevice as x}from"../utils/screen.js";import{isAlive as w}from"mobx-state-tree";import{getLimitedFontSize as v}from"./text-element/max-font-size.js";let y;function S(){return y||(y=document.getElementById("polotno-text-style"),y||(y=document.createElement("style"),y.id="polotno-text-style",document.head.appendChild(y)),y)}l._fixTextRendering=!0;const E={border:"none",padding:"0px",overflow:"hidden",background:"none",outline:"none",resize:"none",overflowWrap:"break-word",whiteSpace:"pre-wrap",userSelect:"text",wordBreak:"normal",textTransform:"none"};function b(t){var e="֑-߿‏‫‮יִ-﷽ﹰ-ﻼ";return new RegExp("^[^"+e+"]*?["+e+"]").test(t)}export function isRTLText(t){t=t.replace(/\s/g,"");let e=0;for(var n=0;n<t.length;n++){b(t[n])&&(e+=1)}return e>t.length/2}export function getDir(t){return isRTLText(t)?"rtl":"ltr"}const z=e(({textNodeRef:e,element:n,onBlur:o,selectAll:r,cursorPosition:i})=>{const[a,l]=t.useState(E),s=e.current;t.useLayoutEffect(()=>{const t={};t.width=s.width()-2*s.padding()+"px",t.height=s.height()-2*s.padding()+s.fontSize()*s.lineHeight()+"px",t.fontSize=s.fontSize()+"px",t.lineHeight=s.lineHeight()+.01,t.fontFamily=s.fontFamily(),t.textAlign=s.align(),t.color=s.fill(),t.fontWeight=n.fontWeight,t.fontStyle=n.fontStyle,t.letterSpacing=n.letterSpacing+"em",t.opacity=Math.max(n.a.opacity,.2),t.textTransform=n.textTransform;const e=`\n        .polotno-input::placeholder {\n          color: ${a.color};\n          opacity: 0.6;\n        }\n      `,o=S();o.innerHTML="",o.appendChild(document.createTextNode(e)),JSON.stringify(t)!==JSON.stringify(a)&&l(t)});const c=t.useRef(null);t.useLayoutEffect(()=>{var t;const e=c.current;if(!e){return}null===(t=c.current)||void 0===t||t.focus();const n=i||e.value.length;e.selectionStart=e.selectionEnd=n,r&&(null==e||e.select(),document.execCommand("selectAll",!1,null))},[]),t.useEffect(()=>{window.addEventListener("blur",o);const t=t=>{var e;(null===(e=c.current)||void 0===e?void 0:e.contains(t.target))||o()};return window.addEventListener("touchstart",t),()=>{window.removeEventListener("blur",o),window.removeEventListener("touchstart",t)}},[]);let d=0;const h=s.textArr.length*s.lineHeight()*s.fontSize();"middle"===n.verticalAlign&&(d=(n.a.height-h)/2),"bottom"===n.verticalAlign&&(d=n.a.height-h);const u=g(n.text);return t.createElement("textarea",{className:"polotno-input",ref:c,dir:getDir(u),style:Object.assign(Object.assign(Object.assign({},E),a),{paddingTop:d+"px"}),value:u,onChange:t=>{const e=v({oldText:n.text,newText:t.target.value,element:n});n.set({text:t.target.value,fontSize:e})},placeholder:n.placeholder,onBlur:o})}),O=e=>t.createElement(i,null,t.createElement(z,Object.assign({},e)));export const useFontLoader=(e,n)=>{const[o,r]=t.useReducer(t=>t+1,0),i=t.useRef(u(n));return t.useLayoutEffect(()=>{if(i.current=u(n),i.current){return}let t=!0;return(async()=>{i.current=!1,r();const o=h(`text ${n}`);await e.loadFont(n),setTimeout(o,100),t&&(i.current=!0,r())})(),()=>{t=!1}},[n]),[i.current]};export const getLineHeight=({fontLoaded:e,fontFamily:n,fontSize:o,lineHeight:r})=>t.useMemo(()=>{if("number"==typeof r){return r}const t=document.createElement("div");t.style.fontFamily=n,t.style.fontSize=o+"px",t.style.lineHeight=r,t.innerText="Test text",document.body.appendChild(t);const e=t.offsetHeight;return document.body.removeChild(t),e/o},[e,n,o,r]);export function usePrevious(e){const n=t.useRef(e),o=t.useRef(e);return t.useMemo(()=>{o.current=n.current,n.current=e},[e]),o.current}export const TextElement=e(({element:e,store:i})=>{const l=t.useRef(null),h=t.useRef(null),{editorEnabled:u,selectAll:v}=(e=>{const[n,o]=t.useState(!1),r=t.useRef(!1);return t.useEffect(()=>{var t=!0;return setTimeout(()=>{t&&(e._editModeEnabled&&(r.current=!0),o(!0),setTimeout(()=>{r.current=!1},50))},50),()=>{t=!1}},[]),{editorEnabled:n&&e._editModeEnabled,selectAll:r.current}})(e),[y,S]=t.useState(!1),E=t.useRef(e.a.height),b=i.selectedShapes.indexOf(e)>=0&&e.selectable,{textVerticalResizeEnabled:z}=f,A=usePrevious(e.fontFamily),[T,L]=t.useState([]);t.useEffect(()=>{var t,e;const n=null!==(e=null===(t=l.current)||void 0===t?void 0:t.textArr)&&void 0!==e?e:[];JSON.stringify(n)!==JSON.stringify(T)&&L(n)}),t.useEffect(()=>{if(e.a.width){return}const t=l.current;t.width(600),e.set({width:1.4*t.getTextWidth()})},[]),t.useEffect(()=>{b||""!==e.text||!e.removable||e.placeholder||i.deleteElements([e.id])},[b]),t.useLayoutEffect(()=>a(()=>{const t=l.current;m(t,e)}));const[k]=useFontLoader(i,e.fontFamily);let F=g(e.text);"uppercase"===e.textTransform&&(F=F.toUpperCase());const M=()=>{const t=l.current.clone({height:void 0}),e=Math.ceil(t.fontSize()*t.lineHeight()*t.textArr.length+1);return t.destroy(),e};t.useLayoutEffect(()=>{if(!k){return}const{textOverflow:t,textSplitAllowed:n}=f;if(!e.a.height){const t=M();return void i.history.ignore(()=>{e.set({height:t})})}if(!i.isPlaying){if("change-font-size"!==t||y){if("resize"===t){const t=M();z&&e.a.height<t&&i.history.ignore(()=>{var n;w(e)&&e.set({height:t}),null===(n=l.current)||void 0===n||n.height(t)},!1,!0),z||e.a.height===t||y||i.history.ignore(()=>{var n;w(e)&&e.set({height:t}),null===(n=l.current)||void 0===n||n.height(t)},!1,!0)}}else{const t=function(t,e,n=!1){const o=t.fontSize(),r=t.height(),i=g(e.text);let a=e.a.fontSize;t.height(void 0);const l=Math.round(2*e.a.fontSize)-1;for(let s=1;s<l;s++){const o=e.a.height&&t.height()>e.a.height;let r=i.split("\n").join(" ").split(/[\s-]+/).reduce((t,e)=>/[\u3000-\u303F\u3040-\u309F\u30A0-\u30FF\uFF00-\uFFEF\u4E00-\u9FAF\uAC00-\uD7AF]/.test(e)?t.concat(e.split("")):t.concat(e),[]),l=t.textArr.map(t=>t.text).join(";");const s=r.find(t=>!l.includes(t)||(l=l.replace(t,""),!1));if(!(o||s&&!n)){break}a-=.5,t.fontSize(a)}return t.fontSize(o),t.height(r),a}(l.current,e,n);if(t!==e.a.fontSize){return void i.history.ignore(()=>{e.set({fontSize:t})},!1,!0)}const o=M();e.a.height===o||z||i.history.ignore(()=>{e.set({height:o})},!1,!0)}}}),t.useLayoutEffect(()=>{const t=l.current;t&&(t.width(t.width()+1e-8),t._setTextData(),m(t,e))},[k]);const R=t.useRef(null),$=t.useRef(0),j=t=>{t.evt.preventDefault();const n=i.selectedShapes.find(t=>t===e);n&&e.contentEditable&&($.current=function(t){var e;const n=t.target,o=function(t){var e=t.getAbsoluteTransform().copy();e.invert();var n=t.getStage().getPointerPosition();return e.point(n)}(n),r=n.textArr,i=Math.floor(o.y/(n.fontSize()*n.lineHeight())),a=r.slice(0,i).reduce((t,e)=>t+e.text.length,i),l=null!==(e=r[i])&&void 0!==e?e:r[0];let s=0;return"right"===n.align()?s=n.width()-l.width:"center"===n.align()&&(s=n.width()/2-l.width/2),a+Math.round((o.x-s)/l.width*l.text.length)}(t),e.toggleEditMode())},H=!F&&e.placeholder?.6:e.a.opacity;p(l,H);const C=getLineHeight({fontLoaded:k,fontFamily:e.fontFamily,fontSize:e.a.fontSize,lineHeight:e.lineHeight}),X=e.selectable||"admin"===i.role,Y=d(e),B=t.useMemo(()=>e.backgroundEnabled?function({lines:t,lineHeight:e,width:n,align:o="left",padding:r=0,cornerRadius:i=0}){var a;t.forEach((t,e)=>{t.cx=n/2,"right"===o?t.cx=n-t.width/2:"left"===o&&(t.cx=t.width/2),"justify"!==o||t.lastInParagraph||(t.width=n),"justify"===o&&(t.cx=t.width/2)});let l=`M ${null===(a=t[0])||void 0===a?void 0:a.cx} ${-r}`;t.forEach((n,o)=>{const{cx:i}=n,a=t[o-1];a&&a.width>n.width?l+=` L ${i+n.width/2+r} ${o*e+r}`:l+=` L ${i+n.width/2+r} ${o*e-r}`;const s=t[o+1];s&&s.width>n.width?l+=` L ${i+n.width/2+r} ${(o+1)*e-r}`:l+=` L ${i+n.width/2+r} ${(o+1)*e+r}`});for(var d=t.length-1;d>=0;d--){const n=t[d],{cx:o}=n,i=t[d+1];i&&i.width>n.width?l+=` L ${o-n.width/2-r} ${(d+1)*e-r}`:l+=` L ${o-n.width/2-r} ${(d+1)*e+r}`;const a=t[d-1];a&&a.width>n.width?l+=` L ${o-n.width/2-r} ${d*e+r}`:l+=` L ${o-n.width/2-r} ${d*e-r}`}l+=" Z";const h=s(l);return c(h,i).path}({lines:JSON.parse(JSON.stringify(T)),cornerRadius:e.backgroundCornerRadius*(e.a.fontSize*C*.5),lineHeight:C*e.a.fontSize,padding:e.backgroundPadding*(e.a.fontSize*C*.5),width:e.a.width,align:e.align}):"",[e.backgroundEnabled,e.backgroundCornerRadius,e.a.fontSize,C,e.backgroundPadding,e.a.width,e.align,T]),D=x();let W=0;return"middle"===e.verticalAlign?W=(e.a.height-T.length*C*e.a.fontSize)/2:"bottom"===e.verticalAlign&&(W=e.a.height-T.length*C*e.a.fontSize),t.createElement(t.Fragment,null,t.createElement(o,{ref:h,x:e.a.x,y:e.a.y,rotation:e.a.rotation,hideInExport:!e.showInExport,listening:!1,visible:e.backgroundEnabled,opacity:e.backgroundOpacity*H,data:B,fill:e.backgroundColor,offsetY:-W}),t.createElement(r,Object.assign({ref:l,id:e.id,name:"element",hideInExport:!e.showInExport,editModeEnabled:e._editModeEnabled,x:e.a.x,y:e.a.y,rotation:e.a.rotation,width:e.a.width,height:e.a.height,text:F||e.placeholder,direction:getDir(F)},Y,{stroke:e.stroke,lineJoin:"round",strokeWidth:e.strokeWidth,fillAfterStrokeEnabled:!0,fontSize:e.a.fontSize,fontFamily:`"${e.fontFamily}", "${A}"`,fontStyle:e.fontStyle+" "+e.fontWeight,textDecoration:e.textDecoration,align:e.align,verticalAlign:e.verticalAlign,draggable:D?e.draggable&&b:e.draggable,preventDefault:!D||b,opacity:H,visible:!e._editModeEnabled,ellipsis:"ellipsis"===f.textOverflow,shadowEnabled:e.shadowEnabled,shadowBlur:e.shadowBlur,shadowOffsetX:e.shadowOffsetX,shadowOffsetY:e.shadowOffsetY,shadowColor:e.shadowColor,shadowOpacity:e.shadowOpacity,lineHeight:C,letterSpacing:e.letterSpacing*e.a.fontSize,listening:X,onDragMove:t=>{e.set({x:t.target.x(),y:t.target.y()})},onDragEnd:t=>{e.set({x:t.target.x(),y:t.target.y()})},onClick:j,onTap:j,onTransformStart:()=>{S(!0),E.current=l.current.height()},onTransform:t=>{var n,o,r;const i=t.target;null===(n=h.current)||void 0===n||n.setAttrs({x:i.x(),y:i.y(),rotation:i.rotation(),scale:i.scale()});const a=(null===(o=i.getStage())||void 0===o?void 0:o.findOne("Transformer")).getActiveAnchor();if("middle-left"===a||"middle-right"===a){const t=i.scaleX(),n=i.width()*t,o=e.a.fontSize;let r=n;n<o&&(r=o,R.current&&i.position(R.current)),i.width(r),i.scaleX(1),i.scaleY(1);const a=M();if("ellipsis"!==f.textOverflow){const t=Math.max(a,E.current);i.height(t),e.set({height:i.height()})}const l=f.textVerticalResizeEnabled?Math.max(a,E.current):M();e.set({x:i.x(),width:i.width(),rotation:i.rotation(),height:l}),m(i,e)}if("top-center"===a||"bottom-center"===a){let n="resize"===f.textOverflow?M():C*e.a.fontSize;t.target.height(Math.max(n,t.target.height()*t.target.scaleY())),t.target.scaleY(1)}R.current=t.target.position();const l=t.target.scaleX();null===(r=h.current)||void 0===r||r.setAttrs({scaleX:1,scaleY:1}),t.target.scaleX(1),t.target.scaleY(1),e.set({fontSize:e.a.fontSize*l,width:t.target.width()*l,x:t.target.x(),y:t.target.y(),rotation:t.target.rotation(),height:t.target.height()*l,shadowBlur:e.shadowBlur*l,shadowOffsetX:e.shadowOffsetX*l,shadowOffsetY:e.shadowOffsetY*l,strokeWidth:e.strokeWidth*l})},onTransformEnd:t=>{var n;const o=t.target.scaleX();t.target.scaleX(1),t.target.scaleY(1),e.set({fontSize:Math.round(e.a.fontSize*o),width:Math.ceil(t.target.width()*o),x:t.target.x(),y:t.target.y(),rotation:t.target.rotation(),height:t.target.height()*o,shadowBlur:e.shadowBlur*o,shadowOffsetX:e.shadowOffsetX*o,shadowOffsetY:e.shadowOffsetY*o,strokeWidth:e.strokeWidth*o}),null===(n=h.current)||void 0===n||n.setAttrs({scaleX:1,scaleY:1}),S(!1)}})),u&&t.createElement(n,{x:e.a.x,y:e.a.y,rotation:e.a.rotation},t.createElement(O,{textNodeRef:l,element:e,selectAll:v,cursorPosition:$.current,onBlur:()=>{e.toggleEditMode(!1)}})))});