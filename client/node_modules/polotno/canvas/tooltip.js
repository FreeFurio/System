import e from"react";import{observer as t}from"mobx-react-lite";import{Html as n}from"react-konva-utils";import{Navbar as o,NavbarGroup as l}from"@blueprintjs/core";import{getTotalClientRect as r}from"../utils/math.js";import{extendToolbar as i}from"../toolbar/element-container.js";import{TextAiWrite as s}from"../toolbar/text-ai-write.js";import{DuplicateButton as a}from"../toolbar/duplicate-button.js";import{RemoveButton as u}from"../toolbar/remove-button.js";import{PositionPicker as c}from"../toolbar/position-picker.js";import{GroupButton as d}from"../toolbar/group-button.js";function m(e,t){return e.classList.contains(t)?e:e.parentElement?m(e.parentElement,t):null}const f=()=>null;export const Tooltip=t(({store:t,page:p,components:v,stageRef:g})=>{var E,h;const b=r(t.selectedShapes),k=t.selectedShapes.every(e=>e.page===p),x=e.useRef(null),[y,C]=e.useState(!1),j=t._hasCroppedImages;t.selectedElements.length,e.useEffect(()=>{var e,t,n;const o=()=>{C(!0)},l=()=>{C(!1)};null===(e=null==g?void 0:g.current)||void 0===e||e.on("dragstart",o),null===(t=null==g?void 0:g.current)||void 0===t||t.on("dragend",l);const r=null===(n=null==g?void 0:g.current)||void 0===n?void 0:n.findOne("Transformer");return null==r||r.on("transformstart",o),null==r||r.on("transformend",l),()=>{var e,t;null===(e=null==g?void 0:g.current)||void 0===e||e.off("dragstart",o),null===(t=null==g?void 0:g.current)||void 0===t||t.off("dragend",l),null==r||r.off("transformstart",o),null==r||r.off("transformend",l)}},[]);const[R,w]=e.useState({fit:!0,needCalculate:!1,token:Math.random()});if(e.useEffect(()=>{0!==t.selectedElements.length&&w({fit:!0,needCalculate:!0,token:Math.random()})},[t.selectedElements,y]),e.useEffect(()=>{setTimeout(()=>{if(!x.current){return}if(!R.needCalculate){return}const e=m(x.current,"polotno-workspace-container");if(!e){return}const t=e.getBoundingClientRect(),n=x.current.getBoundingClientRect(),o=(n.right,t.left,n.top-t.top),l=(n.left,t.left,n.bottom-t.top);o<20&&R.fit&&w({fit:!1,needCalculate:!1,token:R.token}),l-t.height>-20&&!R.fit&&w({fit:!0,needCalculate:!1,token:R.token})},10)},[R.needCalculate,x.current,R.token]),e.useEffect(()=>{const e=m(g.current.content,"polotno-workspace-inner"),n=()=>{t.selectedElements.length&&w({fit:!0,needCalculate:!0,token:Math.random()})};return null==e||e.addEventListener("scroll",n),()=>{null==e||e.removeEventListener("scroll",n)}},[]),0===t.selectedShapes.length){return null}if(y){return null}if(!k){return null}if(t.activePage!==p){return null}if(j){return null}const M=(null==v?void 0:v.Position)||c,O=(null==v?void 0:v.Duplicate)||a,S=(null==v?void 0:v.Remove)||u,T=(null==v?void 0:v.Group)||d,B=(null==v?void 0:v.Lock)||f,L=t.selectedElements[0].type,Y=Object.assign({TextAiWrite:s},v),I=i({components:Y,type:L,usedItems:[]}),P=(null===(h=null===(E=null==g?void 0:g.current)||void 0===E?void 0:E.findOne("Transformer"))||void 0===h?void 0:h.rotation())||0;let F=30;return Math.abs(P)<30&&R.fit&&(F=80),Math.abs(P)>140&&!R.fit&&(F=80),e.createElement(n,{parentNodeFunc:({stage:e})=>{var t,n;return(null===(t=null==e?void 0:e.container())||void 0===t?void 0:t.closest(".polotno-workspace-container"))||(null===(n=null==e?void 0:e.container())||void 0===n?void 0:n.parentNode)},transformFunc:e=>{var t;const n=b.x+b.width/2,o=R.fit?b.y*e.scaleY-F:b.y*e.scaleY+b.height*e.scaleY+F,l=null===(t=null==g?void 0:g.current)||void 0===t?void 0:t.container(),r=(null==l?void 0:l.getBoundingClientRect())||{left:0,top:0},i=null==l?void 0:l.closest(".polotno-workspace-container"),s=(null==i?void 0:i.getBoundingClientRect())||{left:0,top:0},a=r.left-s.left,u=r.top-s.top;return Object.assign(Object.assign({},e),{x:a+e.x+n*e.scaleX,y:u+e.y+o,scaleX:1,scaleY:1})},divProps:{style:{pointerEvents:"none",position:"absolute",zIndex:9}}},e.createElement("div",{ref:x,style:{pointerEvents:"none"}},e.createElement(o,{style:{padding:"2px",borderRadius:"5px",height:"34px",transform:"translate(-50%, -50%)",pointerEvents:"auto"}},e.createElement(l,{style:{height:"30px"}},I.map(n=>{const o=Y[n];return e.createElement(o,{elements:t.selectedElements,element:t.selectedElements[0],store:t,key:n})}),e.createElement(T,{store:t}),e.createElement(B,{store:t}),e.createElement(O,{store:t}),e.createElement(S,{store:t}),e.createElement(M,{store:t})))))});