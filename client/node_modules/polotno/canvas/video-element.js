import e from"react";import{observer as t}from"mobx-react-lite";import{autorun as r}from"mobx";import{Image as n,Group as o,Rect as i,Transformer as a,Arc as h,Text as d}from"react-konva";import c from"use-image";import s from"konva";import{Portal as l}from"react-konva-utils";import{incrementLoader as u,triggerLoadError as g}from"../utils/loader.js";import*as f from"../utils/svg.js";import{flags as m}from"../utils/flags.js";import{applyFilter as p}from"./apply-filters.js";import{useFadeIn as w}from"./use-fadein.js";import{isTouchDevice as v}from"../utils/screen.js";function x(){return document.createElement("canvas")}const y=new window.Image;y.src=f.svgToURL('\n  <svg width="800px" height="800px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n  <path opacity="0.6" d="M4 5.49683V18.5032C4 20.05 5.68077 21.0113 7.01404 20.227L18.0694 13.7239C19.384 12.9506 19.384 11.0494 18.0694 10.2761L7.01404 3.77296C5.68077 2.98869 4 3.95 4 5.49683Z" fill="white"/>\n  <path d="M4 5.49683V18.5032C4 20.05 5.68077 21.0113 7.01404 20.227L18.0694 13.7239C19.384 12.9506 19.384 11.0494 18.0694 10.2761L7.01404 3.77296C5.68077 2.98869 4 3.95 4 5.49683Z" stroke="#323232" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n  </svg>\n');const E=new window.Image;E.src=f.svgToURL('\n  <svg width="800px" height="800px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n  <path opacity="0.6" d="M14 19L14 5C14 3.89543 14.8954 3 16 3L17 3C18.1046 3 19 3.89543 19 5L19 19C19 20.1046 18.1046 21 17 21L16 21C14.8954 21 14 20.1046 14 19Z" fill="white"/>\n  <path opacity="0.6" d="M10 19L10 5C10 3.89543 9.10457 3 8 3L7 3C5.89543 3 5 3.89543 5 5L5 19C5 20.1046 5.89543 21 7 21L8 21C9.10457 21 10 20.1046 10 19Z" fill="white"/>\n  <path d="M14 19L14 5C14 3.89543 14.8954 3 16 3L17 3C18.1046 3 19 3.89543 19 5L19 19C19 20.1046 18.1046 21 17 21L16 21C14.8954 21 14 20.1046 14 19Z" stroke="#323232" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n  <path d="M10 19L10 5C10 3.89543 9.10457 3 8 3L7 3C5.89543 3 5 3.89543 5 5L5 19C5 20.1046 5.89543 21 7 21L8 21C9.10457 21 10 20.1046 10 19Z" stroke="#323232" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n  </svg>\n');export const useCornerRadiusAndCrop=(t,r,n,o,i=0,a=!1)=>{const h=Math.floor(Math.max(t.width*o,1)),d=Math.floor(Math.max(t.height*o,1)),c=Math.min(i*o,h/2,d/2),l=Math.max(t.width/n.width,t.height/n.height)*o,u=t.page._exportingOrRendering&&m.imageDownScalingEnabled&&l<1&&!a,g=0===n.x&&0===n.y&&n.width===(null==r?void 0:r.width)&&n.height===(null==r?void 0:r.height),f=e.useMemo(()=>{if(r&&r.width&&r.height){return g&&0===c&&!u?void 0:x()}},[r,c,u,g]),p=()=>{if(!f||!r){return}f.width=h,f.height=d;const e=f.getContext("2d");if(!e){return}c&&(e.beginPath(),e.moveTo(c,0),e.lineTo(h-c,0),e.arc(h-c,c,c,3*Math.PI/2,0,!1),e.lineTo(h,d-c),e.arc(h-c,d-c,c,0,Math.PI/2,!1),e.lineTo(c,d),e.arc(c,d-c,c,Math.PI/2,Math.PI,!1),e.lineTo(0,c),e.arc(c,c,c,Math.PI,3*Math.PI/2,!1),e.clip());const t=u?function(e,t){var r,n;const o=x();o.width=e.width,o.height=e.height,null===(r=o.getContext("2d"))||void 0===r||r.drawImage(e,0,0,o.width,o.height);const i=function(e,t,r,n,o,i,a){for(var h=new ImageData(t,r),d=new Int32Array(e.data.buffer),c=e.width,s=new Int32Array(h.data.buffer),l=h.width,u=t/i,g=r/a,f=Math.round(1/u),m=Math.round(1/g),p=f*m,w=0;w<h.height;w++){for(var v=0;v<l;v++){for(var x=0+Math.round(v/u)+(0+Math.round(w/g))*c,y=0,E=0,M=0,b=0,L=0;L<m;L++){for(var C=0;C<f;C++){var T=d[x+C+L*c];y+=T<<24>>>24,E+=T<<16>>>24,M+=T<<8>>>24,b+=T>>>24}}y=Math.round(y/p),E=Math.round(E/p),M=Math.round(M/p),b=Math.round(b/p),s[v+w*l]=b<<24|M<<16|E<<8|y}}return h}(o.getContext("2d").getImageData(0,0,o.width,o.height),Math.floor(o.width*t),Math.floor(o.height*t),0,0,o.width,o.height);return o.width=Math.floor(o.width*t),o.height=Math.floor(o.height*t),null===(n=o.getContext("2d"))||void 0===n||n.putImageData(i,0,0),o}(r,l):r,o=u?{x:Math.floor(n.x*l),y:Math.floor(n.y*l),width:Math.floor(n.width*l),height:Math.floor(n.height*l)}:n;e.drawImage(t,o.x,o.y,o.width,o.height,0,0,f.width,f.height)};return e.useLayoutEffect(()=>{p()},[f,t.width,t.height,n.x,n.y,n.width,n.height,i,o,a,t.page._exportingOrRendering,u]),e.useEffect(()=>()=>{f&&"CANVAS"===f.nodeName&&s.Util.releaseCanvas(f)},[f]),[f||r,p]};const M=x(),b=t(({element:t})=>{const r=Math.min(30,t.width/4,t.height/4),n=e.useRef(null);return e.useEffect(()=>{const e=n.current;if(!e){return}const t=new s.Animation(t=>{e.rotate(((null==t?void 0:t.timeDiff)||0)/2)},e.getLayer());return t.start(),()=>{t.stop()}}),e.createElement(o,{x:t.a.x,y:t.a.y,rotation:t.a.rotation,listening:!1,opacity:t.a.opacity,hideInExport:!t.showInExport},e.createElement(i,{width:t.width,height:t.height,fill:"rgba(124, 173, 212, 0.8)"}),e.createElement(h,{ref:n,x:t.width/2,y:t.height/2,fill:"white",outerRadius:Math.abs(r),innerRadius:Math.max(1,r-5),angle:270}))}),L=t(({element:t})=>{const r=Math.max(10,Math.min(30,t.width/25));return e.createElement(o,{x:t.a.x,y:t.a.y,rotation:t.a.rotation,listening:!1,opacity:t.a.opacity,hideInExport:!t.showInExport},e.createElement(i,{width:t.width,height:t.height,fill:"rgba(223, 102, 102, 0.8)"}),e.createElement(d,{text:"Can not load the video...",fontSize:r,width:t.width,height:t.height,align:"center",fill:"white",verticalAlign:"middle",padding:5}))});let C=function(t,r,n){const o=e.useRef("loading"),i=e.useRef(null),[a,h]=e.useState(0),d=e.useRef(),c=e.useRef(),s=e.useRef();return d.current===t&&c.current===r&&s.current===n||(o.current="loading",i.current=void 0,d.current=t,c.current=r,s.current=n),e.useLayoutEffect(function(){if(t){var e=document.createElement("video");return e.addEventListener("canplay",a),e.addEventListener("error",d),r&&(e.crossOrigin=r),n&&(e.referrerpolicy=n),e.src=t,e.load(),function(){e.removeEventListener("canplay",a),e.removeEventListener("error",d)}}function a(){o.current="loaded",i.current=e,i.current.currentTime=0,h(Math.random()),i.current.removeEventListener("canplay",a)}function d(t){var r;const n=4===e.readyState,a=e.buffered&&e.buffered.length>0&&e.buffered.end(e.buffered.length-1)/e.duration*100>=100;if(n&&a){return}const d=t.message||(null===(r=e.error)||void 0===r?void 0:r.message)||"Unknown error",c=new Error("Video failed to load: "+d);console.error(c),o.current="failed",i.current=void 0,h(Math.random())}},[t,r,n]),[i.current,o.current]};export const setVideoLoaderHook=e=>{C=e};function T(e){return e.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA}export const useLoader=(t,r,n)=>{const o=e.useRef(),i=()=>{var e;null===(e=o.current)||void 0===e||e.call(o),o.current=void 0};e.useEffect(()=>i,[]),e.useLayoutEffect(()=>{const e=r.slice(0,200),a=`video with id ${n} url: ${e}`;"loading"!==t||o.current||(o.current=u(a)),"loading"!==t&&i(),"failed"===t&&g(a)},[t])};export const VideoElement=t(({element:t,store:h})=>{var d;const[g,m]=e.useState(!1),R=e.useRef(null),I=e.useRef(null),k=h.selectedShapes.indexOf(t)>=0&&t.selectable,[S,X]=e.useState(!1),[Y,W]=C(t.src,"anonymous"),O=h.activePage===t.page;useLoader(W,t.src,t.id),Y&&(Y.width=Y.videoWidth,Y.height=Y.videoHeight,Y.playsInline=!0);const _=Y||M;e.useEffect(()=>{Y&&h.history.ignore(()=>{t.set({duration:1e3*Y.duration})})},[Y]),e.useEffect(()=>{var e;if(!Y){return}const r=h.animatedElementsIds,n=(!r.length||r.includes(t.id))&&h.isPlaying,o=O&&(n||S);if(!o){return void Y.pause()}o&&(Y.currentTime=t.startTime*Y.duration,Y.play());const i=new s.Animation(()=>{ee()},null===(e=R.current)||void 0===e?void 0:e.getLayer());i.start();const a=()=>{X(!1),Y.currentTime=t.startTime*Y.duration},d=()=>{Y.currentTime>=t.endTime*Y.duration&&(Y.pause(),Y.currentTime=t.startTime*Y.duration,X(!1))};return Y.addEventListener("ended",a),Y.addEventListener("timeupdate",d),()=>{Y.pause(),i.stop(),Y.removeEventListener("ended",a),Y.removeEventListener("timeupdate",d)}},[Y,S,h.isPlaying,O]),e.useEffect(()=>{Y&&(Y.volume=t.volume)},[Y,t.volume]);const P=e.useRef();e.useEffect(()=>{const e=r(()=>{var e,r;if(Y){const n=h.animatedElementsIds;if(n.length&&!n.includes(t.id)){return}const o=t.startTime*Y.duration*1e3,i=Y.duration*(t.endTime-t.startTime)*1e3,a=((h.currentTime||t.page.startTime)-t.page.startTime)%i+o;if(Math.abs(1e3*Y.currentTime-a)>500||!h.isPlaying){const e=a/1e3;e!==Y.currentTime&&(Y.currentTime=e),!T(Y)&&!h.isPlaying&&!P.current&&(P.current=u(`video ${t.id}`))}ee(),null===(r=null===(e=R.current)||void 0===e?void 0:e.getLayer())||void 0===r||r.batchDraw()}});return()=>{e(),P.current&&(P.current(),P.current=null)}},[h,Y]),e.useEffect(()=>{if(!Y){return}const e=()=>{var e,r;!T(Y)&&t.page._exportingOrRendering||P.current&&(ee(),null===(r=null===(e=R.current)||void 0===e?void 0:e.getLayer())||void 0===r||r.batchDraw(),P.current(),P.current=null)};let r;return t.page._exportingOrRendering&&(r=setInterval(e,50)),Y.addEventListener("timeupdate",e),Y.addEventListener("canplay",e),()=>{clearInterval(r),Y.removeEventListener("timeupdate",e),Y.removeEventListener("canplay",e)}},[t.page._exportingOrRendering,Y,t.id,u]);let{cropX:A,cropY:H,cropWidth:D,cropHeight:z}=t;"loaded"!==W&&(A=H=0,D=z=1);const j=_.width*D,B=_.height*z,U=t.width/t.height;let V,Z;const F=j/B,N="svg"===t.type;N?(V=j,Z=B):U>=F?(V=j,Z=j/U):(V=B*U,Z=B);const $={x:_.width*A,y:_.height*H,width:V,height:Z},q=null!==(d=t.cornerRadius)&&void 0!==d?d:0,[G,J]=useCornerRadiusAndCrop(t,_,$,h._elementsPixelRatio,q,g||t._cropModeEnabled||"svg"===t.type);let[K,Q]=((t,r,n,o)=>{const i=(t=>{const[r,n]=e.useState(t);return e.useEffect(()=>{(async()=>{const e=await async function(e){if(!(e.indexOf("data:image/svg+xml")>=0||e.indexOf(".svg")>=0)){return e}const t=await f.urlToString(e),r=f.fixSize(t);return f.svgToURL(r)}(t);e!==r&&n(e)})()},[t]),r})(t.clipSrc||""),[a,h]=c(i,"anonymous"),d=t.clipSrc?h:"loaded";useLoader(d,t.clipSrc,t.id);const l=e.useMemo(()=>{if(r&&a){return x()}},[r,a]);function u(){var e;if(!a){return}if(!r||!r.width||!r.height){return}if(!a||!a.width||!a.height){return}if(!l){return}const o=x(),i=Math.max(t.width/a.width*n,t.height/a.height*n);o.width=a.width*i,o.height=a.height*i,null===(e=o.getContext("2d"))||void 0===e||e.drawImage(a,0,0,o.width,o.height),l.width=Math.max(r.width,1),l.height=Math.max(r.height,1);const h=l.getContext("2d");h&&(h.save(),h.drawImage(o,0,0,r.width,r.height),s.Util.releaseCanvas(o),h.globalCompositeOperation="source-in",h.drawImage(r,0,0,l.width,l.height),h.restore())}return e.useLayoutEffect(()=>{u()},[l,r,a,t.width,t.height,n,...o]),[t.clipSrc&&a?l:r,u]})(t,G,h._elementsPixelRatio,[$,q,h._elementsPixelRatio]);function ee(){J(),Q()}const te=Math.max(t.width/V,t.height/Z);e.useEffect(()=>{var e;if(!t._cropModeEnabled){return}const r=null===(e=R.current)||void 0===e?void 0:e.getStage();function n(e){t._cropModeEnabled&&e.target!==I.current&&t.toggleCropMode(!1)}function o(e){t._cropModeEnabled&&e.target.parentNode!==r.content&&t.toggleCropMode(!1)}return document.body.addEventListener("click",o),null==r||r.on("click",n),null==r||r.on("tap",n),()=>{document.body.removeEventListener("click",o),document.body.removeEventListener("touchstart",o),null==r||r.off("click",n),null==r||r.off("click",n)}},[t._cropModeEnabled]),e.useLayoutEffect(()=>{if(!g&&!t._cropModeEnabled){return p(R.current,t),r(()=>{p(R.current,t)},{delay:100})}},[_,g,D,z,t._cropModeEnabled]),e.useLayoutEffect(()=>{var e;g||t._cropModeEnabled?null===(e=R.current)||void 0===e||e.clearCache():p(R.current,t)},[g,t.width,t.height,t._cropModeEnabled]),e.useEffect(()=>{p(R.current,t)},[t.shadowEnabled,t.shadowBlur,t.cornerRadius,t.shadowColor,t.shadowOffsetX,t.shadowOffsetY,t.shadowOpacity]);const re=e.useRef(null),ne=e.useRef(null),oe=e.useRef(null);e.useLayoutEffect(()=>{t._cropModeEnabled&&(ne.current.nodes([re.current]),oe.current.nodes([I.current]))},[t._cropModeEnabled]);const ie=e=>{Math.round(e.target.x())>0&&(e.target.x(0),e.target.scaleX(1)),Math.round(e.target.y())>0&&(e.target.y(0),e.target.scaleY(1));const r=e.target.width()*e.target.scaleX(),n=e.target.height()*e.target.scaleY(),o=Math.min(1,V/r),i=Math.min(1,Z/n),a=1-o,h=Math.min(a,Math.max(0,Math.round(-e.target.x())/r)),d=1-i,c=Math.min(d,Math.max(0,Math.round(-e.target.y())/n));e.target.setAttrs({x:-h*_.width,y:-c*_.height,scaleX:1,scaleY:1}),t.set({cropX:h,cropY:c,cropWidth:o,cropHeight:i})},ae=()=>{"svg"!==t.type&&t.contentEditable&&setTimeout(()=>{t.toggleCropMode(!0)})},he="loading"===W,de="failed"===W,ce=!he&&!de,se=e.useRef({cropX:0,cropY:0,cropWidth:0,cropHeight:0}),le=ce?t.a.opacity:0;w(R,le);const ue=t.selectable||"admin"===h.role,ge=v();return e.createElement(e.Fragment,null,he&&e.createElement(b,{element:t}),de&&e.createElement(L,{element:t}),e.createElement(n,{ref:R,name:"element",id:t.id,image:K,x:t.a.x,y:t.a.y,width:t.a.width||1,height:t.a.height||1,rotation:t.a.rotation,opacity:le,shadowEnabled:t.shadowEnabled,shadowBlur:t.shadowBlur,shadowOffsetX:t.shadowOffsetX,shadowOffsetY:t.shadowOffsetY,shadowColor:t.shadowColor,shadowOpacity:t.shadowOpacity,customCrop:$,listening:ue,draggable:ge?t.draggable&&k:t.draggable,preventDefault:!ge||k,hideInExport:!t.showInExport,onDragMove:e=>{t.set({x:e.target.x(),y:e.target.y()})},onDragEnd:e=>{t.set({x:e.target.x(),y:e.target.y()})},onDblClick:ae,onDblTap:ae,onTransformStart:()=>{m(!0),se.current={cropX:t.cropX,cropY:t.cropY,cropWidth:t.cropWidth,cropHeight:t.cropHeight}},onTransform:e=>{var r;const n=e.currentTarget,o=Math.abs(n.scaleX()-1)<1e-7?1:n.scaleX(),i=Math.abs(n.scaleY()-1)<1e-7?1:n.scaleY();n.scaleX(1),n.scaleY(1);const a=null===(r=e.target.getStage())||void 0===r?void 0:r.findOne("Transformer"),h=1-V/_.width,d=Math.min(h,Math.max(0,t.cropX)),c=1-Z/_.height,s=Math.min(c,Math.max(0,t.cropY)),l=a.getActiveAnchor(),u=!(l.indexOf("middle")>=0||l.indexOf("center")>=0),g=!u&&o<1&&se.current.cropHeight>Z/_.height;let f=u?t.cropWidth:t.cropWidth*o;g&&(f=t.cropWidth);const m=!u&&i<1&&se.current.cropWidth>V/_.width;let p=u?t.cropHeight:t.cropHeight*i;m&&(p=t.cropHeight),N&&(f=t.cropWidth,p=t.cropHeight),t.set({cropX:d,cropY:s,x:n.x(),y:n.y(),width:n.width()*o,height:n.height()*i,rotation:e.target.rotation(),cropWidth:Math.min(f,1-d),cropHeight:Math.min(p,1-s)})},onTransformEnd:e=>{const r=e.currentTarget;t.set({width:r.width(),height:r.height(),x:r.x(),y:r.y(),rotation:e.target.rotation(),cropWidth:V/_.width,cropHeight:Z/_.height}),m(!1)}}),e.createElement(i,{x:t.a.x,y:t.a.y,width:Math.max(t.a.width-t.borderSize,0),height:Math.max(t.a.height-t.borderSize,0),opacity:le,offsetX:-t.borderSize/2,offsetY:-t.borderSize/2,stroke:t.borderColor,strokeWidth:t.borderSize,listening:!1,visible:!!t.borderSize,rotation:t.rotation,cornerRadius:Math.max(0,q-t.borderSize),hideInExport:!t.showInExport}),!h.isPlaying&&e.createElement(n,{image:S?E:y,x:t.a.x,y:t.a.y,offsetX:-t.a.width/2+15/h.scale,offsetY:-t.a.height/2+15/h.scale,rotation:t.a.rotation,width:30/h.scale,height:30/h.scale,hideInExport:!0,onClick:()=>X(!S),onTap:()=>X(!S)}),t._cropModeEnabled&&e.createElement(l,{selector:".page-abs-container",enabled:!0},e.createElement(i,{x:-window.innerWidth/h.scale,y:-window.innerWidth/h.scale,width:window.innerWidth/h.scale*3,height:window.innerWidth/h.scale*3,fill:"rgba(0,0,0,0.3)"}),e.createElement(n,{listening:!1,image:K,x:t.a.x,y:t.a.y,width:t.a.width,height:t.a.height,rotation:t.a.rotation,shadowEnabled:t.shadowEnabled,shadowBlur:t.shadowBlur}),e.createElement(o,{x:t.a.x,y:t.a.y,rotation:t.a.rotation,scaleX:te,scaleY:te},e.createElement(n,{image:_,ref:I,opacity:.4,draggable:!0,x:-t.cropX*_.width,y:-t.cropY*_.height,onDragMove:ie,onTransform:ie}),e.createElement(a,{ref:oe,anchorSize:20,enabledAnchors:["top-left","top-right","bottom-left","bottom-right"],boundBoxFunc:(e,t)=>t.width<5||t.height<5?e:t,rotateEnabled:!1,borderEnabled:!1,anchorCornerRadius:10,anchorStrokeWidth:2,borderStrokeWidth:2}),e.createElement(i,{width:V,height:Z,ref:re,listening:!1,onTransform:e=>{e.target.x()<-t.cropX*_.width-1e-9&&(e.target.x(-t.cropX*_.width),e.target.scaleX(1)),e.target.y()<-t.cropY*_.height-1e-9&&(e.target.y(-t.cropY*_.height),e.target.scaleY(1));const r=Math.min(1,Math.max(0,t.cropX+e.target.x()/_.width)),n=Math.min(1,Math.max(0,e.target.y()/_.height+t.cropY)),o=e.target.width()*e.target.scaleX(),i=e.target.height()*e.target.scaleY(),a=Math.min(1-r,o/_.width),h=Math.min(1-n,i/_.height),d=e.target.getAbsolutePosition(e.target.getParent().getParent());e.target.scale({x:1,y:1}),e.target.position({x:0,y:0}),t.set({x:d.x,y:d.y,cropX:r,cropY:n,cropWidth:a,cropHeight:h,width:Math.min(o*te,_.width*(1-r)*te),height:Math.min(i*te,_.height*(1-n)*te)})}}),e.createElement(a,{ref:ne,enabledAnchors:["top-left","top-right","bottom-left","bottom-right"],boundBoxFunc:(e,t)=>t.width<5||t.height<5?e:t,keepRatio:!1,rotateEnabled:!1,anchorFill:"rgb(240, 240, 240)",anchorStrokeWidth:2,borderStrokeWidth:2,visible:t.resizable}))))});