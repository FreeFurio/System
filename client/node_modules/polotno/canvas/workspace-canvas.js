import e from"react";import{observer as t}from"mobx-react-lite";import r from"./page.js";import{TopRules as n}from"./rules.js";import{AudioElement as o}from"./audio.js";import{handleHotkey as i}from"./hotkeys.js";import{t as a}from"../utils/l10n.js";const l=({store:t})=>e.createElement("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",textAlign:"center"}},e.createElement("p",null,a("workspace.noPages")),e.createElement("button",{onClick:()=>{t.addPage()}},a("workspace.addPage"))),s=({width:t,height:r,xPadding:n,yPadding:o,backgroundColor:i})=>e.createElement("div",{style:{width:t+"px",height:r+"px",backgroundColor:i,paddingLeft:n+"px",paddingRight:n+"px",paddingTop:o+"px",paddingBottom:o+"px"}},e.createElement("div",{style:{width:" 100%",height:"100%",backgroundColor:"white"}})),c=[4,6];export const WorkspaceCanvas=t(({store:t,pageControlsEnabled:a,backgroundColor:u,pageBorderColor:d,activePageBorderColor:h,bleedColor:g,snapGuideStroke:p,snapGuideStrokeWidth:f,snapGuideDash:m,selectionRectFill:v,selectionRectStroke:w,selectionRectStrokeWidth:b,transformLabelFill:k,transformLabelTextFill:E,components:y,onKeyDown:x,paddingX:P,paddingY:T,altCloneEnabled:R=!0,visiblePagesOffset:C,renderOnlyActivePage:M})=>{var L;const S=null!=P?P:20,F=null!=T?T:55,[W,O]=e.useState({width:100,height:100}),_=e.useRef(W),j=e.useRef(null),z=e.useRef(null),B=t.bleedVisible?Math.max(0,...t.pages.map(e=>e.bleed)):0,G=Math.max(...t.pages.map(e=>e.computedWidth)),H=Math.max(...t.pages.map(e=>e.computedHeight)),D=(null===(L=t.activePage)||void 0===L?void 0:L.computedHeight)||0,N=G+2*B,I=(M?D:H)+2*B,K=async({skipTimeout:e}={skipTimeout:!1})=>{if(e||await new Promise(e=>setTimeout(e,50)),null===j.current){return}const r=j.current.getBoundingClientRect();0!==r.width&&0!==r.height||(console.warn("Polotno warning: <Workspace /> component can not automatically detect its size.\nWidth or height of parent elements is equal 0.\nPlease make sure it has non-zero size. You may need to adjust it with your styles. <Workspace /> will automatically fit into parent container.\nFor simpler debugging here is the log of the parent element:"),console.log(j.current));const n=z.current.clientWidth||r.width,o={width:n,height:r.height};(_.current.width!==o.width||_.current.height!==o.height)&&(O(o),_.current=o);const i=(n-2*S)/N,a=t.pages.length>1?3.1:2,l=(r.height-F*a)/I,s=t.pages.length?Math.max(Math.min(i,l),.01):1;t.scaleToFit!==s&&(t.setScale(s),t._setScaleToFit(s))};e.useLayoutEffect(()=>{K({skipTimeout:!0})},[]),e.useEffect(()=>{K()},[N,I,T,P]),e.useEffect(()=>{t.__()},[]),e.useEffect(()=>{const e=j.current;if(window.ResizeObserver){const t=new ResizeObserver(()=>{K({skipTimeout:!0})});return t.observe(e),()=>t.unobserve(e)}{const e=setInterval(()=>{K({skipTimeout:!0})},100);return()=>clearInterval(e)}},[N,I]);const Y=Math.max(S,(W.width-N*t.scale)/2),A=M?1:t.pages.length,V=I*t.scale*A,X=Math.max(F,(W.height-V)/A/2);e.useEffect(()=>{const e=e=>{(x||i)(e,t)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),e.useEffect(()=>{var e;const r=e=>{if(e.ctrlKey||e.metaKey){e.preventDefault();const i=Math.max(5,t.scaleToFit),a=Math.min(.1,t.scaleToFit),l=.03,s=(r=e.deltaY<0?t.scale*(1+l):t.scale/(1+l),n=a,o=i,Math.max(n,Math.min(o,r)));return void t.setScale(s)}var r,n,o};return null===(e=z.current)||void 0===e||e.addEventListener("wheel",r),()=>{var e;return null===(e=z.current)||void 0===e?void 0:e.removeEventListener("wheel",r)}},[]);const q=e.useRef(!1);((t,r,n,o,i,a)=>{const l=e.useRef({width:r,height:n}),s=e.useRef({top:0,left:0}),c=e.useRef(!1),u=e.useRef(i.pages.length);c.current=u.current!==i.pages.length,u.current=i.pages.length,e.useEffect(()=>{const e=t.current,r=t=>{s.current={top:e.scrollTop,left:e.scrollLeft}};return e.addEventListener("scroll",r),()=>{e.removeEventListener("scroll",r)}},[]),e.useLayoutEffect(()=>{if(!t.current){return}if(c.current){return}const e=t.current,o=(s.current.left+e.offsetWidth/2)/l.current.width,i=(s.current.top+e.offsetHeight/2)/l.current.height;a.current=!0,e.scrollLeft=o*r-e.offsetWidth/2,e.scrollTop=i*n-e.offsetHeight/2,l.current={width:r,height:n}},[o,r,n])})(z,N*t.scale+2*Y,I*t.scale+2*X,t.scale,t,q);const{handleScroll:J}=((t,r,n,o,i,a)=>{const l=e.useRef(!1),s=e.useRef(null),c=e.useRef(!1);e.useEffect(()=>{const e=t.current,r=()=>{i.current};return e.addEventListener("scroll",r),()=>{e.removeEventListener("scroll",r)}},[]);const u=n.pages.indexOf(n.activePage);return e.useLayoutEffect(()=>{if(a){return}if(!n.activePage){return}if(!t.current){return}if(l.current){return}const e=t.current,o=n.pages.indexOf(n.activePage)*r;let i=()=>{};return(Math.abs(o-e.scrollTop)>.5*r||c.current)&&(c.current=!0,i=(({element:e,scrollTop:t=0,duration:r=300,onFinish:n=()=>{}})=>{const o=e.scrollTop,i=t-o;let a=0,l=!1;if(0===r){return e.scrollTop=t,()=>{}}const s=()=>{if(l){return}a+=20;const t=c(a,o,i,r);e.scrollTop=t,a<r?setTimeout(s,20):n()},c=(e,t,r,n)=>(e/=n/2)<1?r/2*e*e+t:-r/2*(--e*(e-2)-1)+t;return s(),()=>{l=!0}})({element:e,scrollTop:o,onFinish:()=>{c.current=!1},duration:n.isPlaying?0:300})),i},[n.activePage,u,n.isPlaying,a]),{handleScroll:e=>{if(a){return}if(c.current){return}l.current=!0,clearTimeout(s.current),s.current=setTimeout(()=>{l.current=!1},300);const t=e.currentTarget.childNodes[0].offsetHeight,r=e.currentTarget.scrollTop,i=Math.floor((r+o.height/3)/t),u=n.pages[i];u&&n.activePage!==u&&u.select()}}})(z,I*t.scale+2*X,t,W,q,M),Q=W.width>=N*t.scale+2*Y,U=u||"rgba(232, 232, 232, 0.9)",Z=t.pages.indexOf(t.activePage),$=(null==y?void 0:y.NoPages)||l,ee=null!=C?C:Math.min(3,Math.max(1,Math.ceil(W.height/2/(I*t.scale))));return e.createElement("div",{ref:j,style:{width:"100%",height:"100%",position:"relative",outline:"none",flex:1,backgroundColor:U,overflow:"hidden"},tabIndex:0,className:"polotno-workspace-container"},e.createElement("div",{ref:z,onScroll:J,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",overflow:"auto",overflowX:Q?"hidden":"auto"},className:"polotno-workspace-inner"},t.pages.map((n,o)=>{const i=n===t.activePage;if(M&&!i&&!n._exportingOrRendering&&!n._forceMount){return null}if(!(Math.abs(o-Z)<=ee||n._exportingOrRendering||n._forceMount)){return e.createElement(s,{key:n.id,width:N*t.scale+2*Y,height:I*t.scale+2*X,backgroundColor:U,xPadding:Y,yPadding:X})}const l=e.createElement(r,{key:n.id,page:n,xPadding:Y,yPadding:X,width:N*t.scale+2*Y,height:I*t.scale+2*X,store:t,pageControlsEnabled:a,backColor:U,pageBorderColor:d||"lightgrey",activePageBorderColor:h||"rgb(0, 161, 255)",altCloneEnabled:R,bleedColor:g||"rgba(255, 0, 0, 0.1)",selectionRectFill:v,selectionRectStroke:w,selectionRectStrokeWidth:b,snapGuideStroke:p||"rgb(0, 161, 255)",snapGuideStrokeWidth:f||1,snapGuideDash:m||c,transformLabelFill:k,transformLabelTextFill:E,components:y,viewportSize:W});return(n._exportingOrRendering||n._forceMount)&&!i&&M?e.createElement("div",{style:{display:"none"},key:n.id},l):l}),t.rulesVisible&&e.createElement(n,{store:t,xPadding:Y,yPadding:X,width:N*t.scale+2*Y,height:I*t.scale+2*X}),0===t.pages.length&&e.createElement($,{store:t}),t.audios.map(r=>e.createElement(o,{key:r.id,audio:r,store:t}))))});export default WorkspaceCanvas;