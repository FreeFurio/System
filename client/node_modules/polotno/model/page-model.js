import{types as e,detach as t,getParentOfType as n,getSnapshot as o}from"mobx-state-tree";import{nanoid as i}from"nanoid";import{ElementTypes as r}from"./group-model.js";import{Store as d}from"./store.js";import{forEveryChild as s,TYPES_MAP as c}from"./group-model.js";import{getTotalClientRect as a}from"../utils/math.js";export const Page=e.model("Page",{id:e.identifier,children:e.array(e.late(()=>r)),width:e.optional(e.union(e.number,e.literal("auto")),"auto"),height:e.optional(e.union(e.number,e.literal("auto")),"auto"),background:"white",bleed:0,custom:e.frozen(),duration:5e3,_exporting:!1,_rendering:!1,_forceMount:!1}).postProcessSnapshot(e=>{const t=Object.assign({},e),n={};for(var o in t){"_"!==o[0]&&(n[o]=e[o])}return n}).views(e=>({get store(){return n(e,d)}})).views(e=>({get startTime(){let t=0;for(const n of e.store.pages){if(n.id===e.id){return t}t+=n.duration}return t},get _exportingOrRendering(){return e._exporting||e._rendering}})).views(e=>({get computedWidth(){return"auto"===e.width?e.store.width:e.width},get computedHeight(){return"auto"===e.height?e.store.height:e.height}})).actions(e=>({toJSON:()=>JSON.parse(JSON.stringify(o(e))),_forEachElementUp(t,n){const o=t.map(t=>({id:t,index:e.children.findIndex(e=>e.id===t)}));o.sort((e,t)=>t.index-e.index);for(const{index:i}of o){if(-1==i){continue}const o=i<e.children.length-1&&e.children[i+1],r=t.indexOf(null==o?void 0:o.id)>=0;i===e.children.length-1||r||n(i)}},_forEachElementDown(t,n){const o=t.map(t=>({id:t,index:e.children.findIndex(e=>e.id===t)}));o.sort((e,t)=>e.index-t.index);for(const{index:i}of o){if(-1==i){continue}const o=i>0&&e.children[i-1],r=t.indexOf(null==o?void 0:o.id)>=0;0===i||r||n(i)}return!1}})).actions(e=>({clone(t={}){const n=e.toJSON();n.children.forEach(e=>{e.id=i(10),s(e,e=>{e.id=i(10)})});const o=Object.assign(Object.assign(Object.assign({},n),{id:i(10)}),t),r=e.store.addPage(o),d=e.store.pages.indexOf(e);return r.setZIndex(d+1),r.select(),r},setZIndex(t){e.store.setPageZIndex(e.id,t)},set(t){Object.assign(e,t)},select(){e.store.selectPage(e.id)},addElement(t,{skipSelect:n=!1}={}){const o=c[t.type];if(!o){return void console.error("Can not find model with type "+t.type)}"children"in t&&Array.isArray(t.children)&&s(t,e=>{e.id=e.id||i(10)});const r=o.create(Object.assign({id:i(10)},t));return e.children.push(r),r.selectable&&!n&&e.store.selectElements([r.id]),r},canMoveElementsUp(t){let n=!1;return e._forEachElementUp(t,()=>{n=n||!0}),n},moveElementsUp(n){e._forEachElementUp(n,n=>{const o=e.children[n];t(o),e.children.splice(n+1,0,o)})},canMoveElementsTop(e){return this.canMoveElementsUp(e)},moveElementsTop(t){const n=[],o=[];e.children.forEach(e=>{t.indexOf(e.id)>=0?n.push(e):o.push(e)}),e.children.replace(o.concat(n))},canMoveElementsDown(t){let n=!1;return e._forEachElementDown(t,()=>{n=n||!0}),n},moveElementsDown(n){e._forEachElementDown(n,n=>{const o=e.children[n];t(o),e.children.splice(n-1,0,o)})},canMoveElementsBottom(e){return this.canMoveElementsDown(e)},moveElementsBottom(t){const n=[],o=[];e.children.forEach(e=>{t.indexOf(e.id)>=0?n.push(e):o.push(e)}),e.children.replace(n.concat(o))},setElementZIndex(n,o){const i=e.children.find(e=>e.id===n);i&&(t(i),e.children.remove(i),e.children.splice(o,0,i))},setSize({width:t,height:n,useMagic:o,softChange:i}){if(o){const o=[],i=t=>"image"===t.type&&t.x<1&&t.y<1&&t.width>=e.computedWidth-2&&t.height>=e.computedHeight-2;s(e,e=>{"group"!==e.type&&(i(e)||o.push(e))});const r=o.length?a(o):{x:0,y:0,width:e.computedWidth,height:e.computedHeight},d=1/4,c=Math.max(0,Math.min(r.x,e.computedWidth-r.x-r.width)),m=e.computedWidth*d,h=Math.max(0,c-m),l=Math.max(0,Math.min(r.y,e.computedHeight-r.y-r.height)),p=e.computedHeight*d,g=Math.max(0,l-p),u=e.computedWidth-2*h,f=e.computedHeight-2*g,E=t/u,x=n/f,v=Math.min(E,x),w=(t-u*v)/2-h*v,y=(n-f*v)/2-g*v;s(e,e=>{"group"!==e.type&&(i(e)?e.set({x:e.x*v,y:e.y*v,width:e.width*E,height:e.height*x,cropX:0,cropY:0,cropWidth:1,cropHeight:1}):(e.set({x:w+e.x*v,y:y+e.y*v,width:e.width*v,height:e.height*v}),"text"===e.type?e.set({fontSize:e.fontSize*v}):"figure"===e.type&&e.set({strokeWidth:e.strokeWidth*v})))})}i||(e.width=t),i||(e.height=n)}})).actions(e=>({moveElementUp(t){console.warn("page.moveElementUp(id) is deprecated. Please use page.moveElementsUp([id1, id2]) instead."),e.moveElementsUp([t])},moveElementDown(t){console.warn("page.moveElementDown(id) is deprecated. Please use page.moveElementsDown([id1, id2]) instead."),e.moveElementsDown([t])},moveElementTop(t){console.warn("page.moveElementTop(id) is deprecated. Please use page.moveElementsTop([id1, id2]) instead."),e.moveElementsTop([t])},moveElementBottom(t){console.warn("page.moveElementBottom(id) is deprecated. Please use page.moveElementsBottom([id1, id2]) instead."),e.moveElementsBottom([t])},play(){e.store.play({startTime:e.startTime,endTime:e.startTime+e.duration})}}));