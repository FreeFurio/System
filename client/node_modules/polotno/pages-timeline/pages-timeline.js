import{observer as e}from"mobx-react-lite";import{reaction as t}from"mobx";import n from"react";import{onSnapshot as o}from"mobx-state-tree";import{Button as i,Navbar as a,Popover as r,Menu as l,MenuItem as s,Position as d}from"@blueprintjs/core";import{Play as c,Plus as p,Pause as m,Duplicate as u,Insert as g,Trash as h,More as x,Play as v}from"@blueprintjs/icons";import{ReactSortable as E}from"react-sortablejs";import{flags as f}from"../utils/flags.js";import b from"../utils/styled.js";import{t as w}from"../utils/l10n.js";import{deepEqual as y}from"../utils/deep-equal.js";const T=b("div")`
  position: relative;
  height: 0px;
`,P=b("div")`
  position: absolute;
  bottom: 5px;
  width: auto;
  left: 5px;
  overflow: hidden;
  box-shadow: 0 0 4px lightgrey;
  border-radius: 5px;
  z-index: 1;
`,M=b("div",n.forwardRef)`
  display: flex;
  position: relative;
  border-radius: 15px;

  &:hover {
    .polotno-page-menu {
      opacity: 1;
      pointer-events: auto;
    }
  }
`,k=b("div")`
  position: relative;

  &:hover {
    .polotno-audio-menu {
      opacity: 1;
      pointer-events: auto;
    }
  }
`,C=b("div")`
  position: absolute;
  z-index: 20;
  top: 5px;
  right: 5px;
  opacity: 0;
  pointer-events: none;

  &:hover {
    display: block;
  }
`,D=b("div")`
  border: 4px solid rgba(0, 0, 0, 0.1);
  border-left-color: #09f;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
`,L=b("div")`
  position: absolute;
  z-index: 20;
  top: -5px;
  right: 8px;
  opacity: 0;
  pointer-events: none;

  &:hover {
    display: block;
  }
`;let R=[],z=!1;const I=async()=>{if(z||0===R.length){return}z=!0;const{page:e,setPreview:t}=R.shift();try{t(await e.store.toDataURL({pageId:e.id,pixelRatio:.1,quickMode:!0}))}catch(n){if(n.message.includes("Canvas was unmounted.")){return}throw n}z=!1,I()},$=e(({page:e,scale:a})=>{const[c,p]=n.useState(null),m=e.store.activePage===e,v=e.store,E=n.useRef(!1);n.useEffect(()=>{const n=()=>{R.push({page:e,setPreview:p}),I()};let i=null,a=null,r=Date.now();const l=()=>{i&&clearTimeout(i),E.current&&(a||(a=setTimeout(()=>{Date.now()-r>=6e3&&(n(),r=Date.now(),a=null)},6e3)),i=setTimeout(()=>{n(),r=Date.now(),i=null,a&&(clearTimeout(a),a=null)},300))};let s=null;const d=o(e,e=>{y(s,e)||(l(),s=e)}),c=t(()=>e.children.some(e=>e._editModeEnabled),e=>{e||l()}),m=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting?(E.current=!0,l()):(i&&clearTimeout(i),a&&clearTimeout(a),E.current=!1)})},{threshold:.1});return b.current&&m.observe(b.current),()=>{m.disconnect(),i&&clearTimeout(i),a&&clearTimeout(a),d(),c(),R=R.filter(t=>t.page!==e)}},[]);const b=n.useRef(null),T=60/e.computedHeight*e.computedWidth,P=f.animationsEnabled?e.duration*a:T,k=v.pages.length>1;return n.createElement(M,{style:{width:P+"px",marginRight:f.animationsEnabled?"0px":"10px",height:"60px"},ref:b,className:"polotno-page-container"},n.createElement("div",{style:{width:"100%",height:"100%",borderRadius:"15px",backgroundImage:c?`url("${c}")`:"none",backgroundRepeat:"repeat-x",backgroundSize:"auto 100%",backgroundColor:"white",display:"flex",justifyContent:"center",alignItems:"center"},onClick:()=>{e.store.selectPage(e.id)}},!c&&n.createElement(D,null)),n.createElement("div",{style:{position:"absolute",top:"0",left:"0px",bottom:"0px",right:"0px",borderRadius:"15px",border:m?"2px solid rgb(0, 161, 255, 0.9)":"2px solid lightgrey",zIndex:1,pointerEvents:"none"}}),f.animationsEnabled&&n.createElement("div",{style:{position:"absolute",zIndex:1,bottom:"5px",left:"5px",backgroundColor:"rgba(0, 0, 0, 0.5)",color:"white",padding:"2px 7px",textAlign:"center",borderRadius:"4rem"}},(e.duration/1e3).toFixed(1),"s"),f.animationsEnabled&&n.createElement("div",{style:{position:"absolute",zIndex:1,top:"50%",right:"0px",width:"8px",height:"50%",transform:"translateY(-50%) translateX(-3px)",borderRadius:"5px",border:"1px solid rgb(255, 255, 255, 0.6)",backgroundColor:"rgb(0, 0, 0, 0.6)",cursor:"ew-resize"},onMouseDown:t=>{(t=>{t.preventDefault();const n=t=>{t.preventDefault();const{clientX:n}=t,{left:o,width:i}=b.current.getBoundingClientRect(),a=(n-o- -7)/i;e.set({duration:Math.max(1e3,a*e.duration)})};window.addEventListener("mousemove",n),window.addEventListener("mouseup",()=>{window.removeEventListener("mousemove",n)})})(t)}}),n.createElement(C,{className:"polotno-page-menu",onClick:e=>{e.stopPropagation()}},n.createElement(r,{content:n.createElement(l,{style:{width:"100px"}},n.createElement(s,{icon:n.createElement(u,null),text:w("pagesTimeline.duplicatePage"),onClick:()=>{e.clone()}}),n.createElement(s,{icon:n.createElement(g,null),text:w("pagesTimeline.addPage"),onClick:()=>{var t,n,o;const i=v.addPage({bleed:(null===(t=v.activePage)||void 0===t?void 0:t.bleed)||0,width:(null===(n=v.activePage)||void 0===n?void 0:n.width)||"auto",height:(null===(o=v.activePage)||void 0===o?void 0:o.height)||"auto"}),a=v.pages.indexOf(e);i.setZIndex(a+1)}}),k&&n.createElement(s,{icon:n.createElement(h,null),text:w("pagesTimeline.removePage"),onClick:()=>{e.store.deletePages([e.id])}})),position:d.TOP},n.createElement(i,{icon:n.createElement(x,null),style:{minHeight:"20px",borderRadius:"10px"}}))))}),S=e(({store:e,scale:t})=>{var o;const i=e.isPlaying?e.currentTime:(null===(o=e.activePage)||void 0===o?void 0:o.startTime)||0;return n.createElement("div",{style:{position:"absolute",left:i*t+"px",top:"-5px",width:"2px",height:"calc(100% + 10px)",backgroundColor:"rgb(0, 161, 255, 0.9)"}})});export const Pages=e(({store:e,scale:t})=>{const o=e.pages.map(e=>({id:e.id}));return n.createElement(n.Fragment,null,n.createElement(E,{list:o,setList:t=>{t.forEach(({id:t},n)=>{const o=e.pages.find(e=>e.id===t);e.pages.indexOf(o)!==n&&o.setZIndex(n)})},direction:"horizontal",style:{display:"flex",flexDirection:"row"},delay:500,delayOnTouchOnly:!0,className:"polotno-pages-container"},o.map(({id:o})=>{const i=e.pages.find(e=>e.id===o);return n.createElement($,{page:i,scale:t,key:o})})))});const j=e(({audio:e,scale:t,store:o,index:a})=>{const c=o.duration*t-e.delay*t,p=Math.min((e.endTime-e.startTime)*e.duration*t,c),m=e.delay*t,{data:u,isLoading:g}=function(e){const[t,o]=n.useState(null),[i,a]=n.useState(!1),[r,l]=n.useState(null);return n.useEffect(()=>{var t;e?(a(!0),(t=e,new Promise(e=>{const n=new AudioContext;fetch(t).then(e=>e.arrayBuffer()).then(e=>n.decodeAudioData(e)).then(t=>{const n=t.getChannelData(0),o=Math.max(1,Math.floor(n.length/100)),i=[];for(let e=0;e<n.length;e+=o){let t=0;for(let i=0;i<o&&e+i<n.length;i++){t=Math.max(t,Math.abs(n[e+i]))}i.push(t)}e(i)})})).then(e=>{o(e),a(!1)}).catch(e=>{console.error("Error generating waveform:",e),l(e),a(!1)})):o(null)},[e]),{data:t,isLoading:i,error:r}}(e.src),v=function(e,t,o,i,a=20){const[r,l]=n.useState("");return n.useEffect(()=>{l(e&&t>0?function(e,t,n,o,i){let a="";const r=t/2,l=Math.floor(e.length*o),s=Math.ceil(e.length*i),d=e.slice(l,s);if(0===d.length){return""}d.forEach((e,t)=>{const o=t/(d.length-1)*n,i=r-e*r;a+=0===t?`M ${o},${i}`:` L ${o},${i}`});for(let c=d.length-1;c>=0;c--){const e=c/(d.length-1)*n,t=r+d[c]*r;a+=` L ${e},${t}`}return a+=" Z",a}(e,a,t,o,i):"")},[e,t,a,o,i]),r}(u,p,e.startTime,e.endTime,20),E=e=>{const n=o.pages;let i=e;for(const o of n){const n=o.startTime,a=o.startTime+o.duration;if(Math.abs(e-n)<10/t){return i=n,i}if(Math.abs(e-a)<10/t){return i=a,i}}return null},f=(n,o)=>{n.stopPropagation(),n.preventDefault();const i=n.clientX,a=m,r=p,l=e.endTime,s=e.startTime,d=n=>{n.preventDefault();const d=(n.clientX-i)/t;if("start"===o){let n=Math.max(0,a/t+d);n=E(n)||n;const o=d/e.duration,i=Math.min(e.endTime-.1,Math.max(0,s+o));e.set({delay:n,startTime:i})}else{const n=a/t+r/t;let o=n+d;o=E(o)||o;const i=(o-n)/e.duration,s=Math.min(1,Math.max(e.startTime+.1,l+i));e.set({endTime:s})}},c=()=>{window.removeEventListener("mousemove",d),window.removeEventListener("mouseup",c)};window.addEventListener("mousemove",d),window.addEventListener("mouseup",c)};return n.createElement(k,{style:{position:"absolute",left:`${m}px`,top:20*a+"px",width:`${p}px`,height:"20px",backgroundColor:"rgba(0, 161, 255, 0.5)",borderRadius:"8px",cursor:"move"},onMouseDown:n=>{const o=n.clientX,i=m;n.preventDefault();const a=n=>{n.preventDefault();const a=(n.clientX-o)/t;let r=i/t+a;const l=(e.endTime-e.startTime)*e.duration,s=r+l,d=E(r),c=E(s),p=Math.abs(r-d),m=Math.abs(s-c);let u;u=null!==d&&p<m?Math.max(0,d):null!==c?Math.max(0,c-l):Math.max(0,r),e.set({delay:u})},r=()=>{window.removeEventListener("mousemove",a),window.removeEventListener("mouseup",r)};window.addEventListener("mousemove",a),window.addEventListener("mouseup",r)},className:"polotno-audio-container"},v&&n.createElement("svg",{width:"100%",height:"100%",viewBox:`0 0 ${p} 20`,preserveAspectRatio:"none"},n.createElement("path",{d:v,fill:"rgba(255, 255, 255, 0.5)"})),g&&n.createElement("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"}},n.createElement(D,null)),n.createElement("div",{style:{position:"absolute",left:"0",top:"0",width:"10px",height:"100%",cursor:"ew-resize"},onMouseDown:e=>f(e,"start")}),n.createElement("div",{style:{position:"absolute",right:"0",top:"0",width:"10px",height:"100%",cursor:"ew-resize"},onMouseDown:e=>f(e,"end")}),n.createElement(L,{className:"polotno-audio-menu",onClick:e=>{e.stopPropagation()}},n.createElement(r,{content:n.createElement(l,{style:{width:"100px"}},n.createElement(s,{icon:n.createElement(h,null),text:w("pagesTimeline.removeAudio"),onClick:()=>{o.removeAudio(e.id)}})),position:d.TOP},n.createElement(i,{icon:n.createElement(x,null),style:{minHeight:"20px",borderRadius:"10px",padding:"0px"}}))))}),N=e(({store:e,scale:t})=>n.createElement("div",{style:{position:"absolute",bottom:"-15px",paddingTop:"5px"},className:"polotno-audios-container"},e.audios.map((o,i)=>n.createElement(j,{key:o.id,audio:o,scale:t,store:e,index:i})))),O=e=>{const t=Math.floor(e/6e4),n=Math.floor(e%6e4/1e3);return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`},X=b("div")`
  position: absolute;
  top: 5px;
  left: 5px;
  padding-right: 8px;
  z-index: 2;
  width: 100px;
  text-align: center;
`,A=e(({store:e})=>n.createElement(X,{className:"polotno-play-button-container"},n.createElement(i,{icon:e.isPlaying?n.createElement(m,{size:25}):n.createElement(c,{size:25}),onClick:()=>{var t;if(e.isPlaying){const t=e.activePage;e.stop(),t&&e.selectPage(t.id)}else{e.play({startTime:(null===(t=e.activePage)||void 0===t?void 0:t.startTime)||0})}},style:{width:"60px",height:"60px",borderRadius:"50px"}}),n.createElement("div",{style:{paddingTop:"5px"}},O(e.currentTime)," / ",O(e.duration))));export const PagesTimeline=e(({store:e,defaultOpened:t=!1})=>{const o=.02,[r,l]=n.useState(t),s=f.animationsEnabled?10*e.audios.length+90:90;return n.createElement(n.Fragment,null,n.createElement(T,null,n.createElement(P,null,n.createElement(a,{style:{height:"35px",padding:"0 5px"}},n.createElement(a.Group,{style:{height:"35px"}},n.createElement(i,{minimal:!0,onClick:()=>{l(!r)},icon:f.animationsEnabled&&!r?n.createElement(v,null):null},w("pagesTimeline.pages")))))),n.createElement(a,{style:{padding:"5px",height:"auto",zIndex:1,display:r?"block":"none"},className:"polotno-pages-timeline"},n.createElement("div",{style:{width:"100%",position:"relative",height:s}},n.createElement("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,overflowX:"auto",padding:"5px",zIndex:1,display:"flex"}},n.createElement("div",{style:{height:"60px",display:"flex"}},f.animationsEnabled&&n.createElement("div",{style:{width:"90px",paddingRight:"5px",paddingLeft:"60px"}}),n.createElement("div",{style:{position:"relative"}},n.createElement(Pages,{store:e,scale:o}),f.animationsEnabled&&n.createElement(S,{store:e,scale:o}),f.animationsEnabled&&n.createElement(N,{store:e,scale:o})),n.createElement(i,{icon:n.createElement(p,null),style:{width:"60px"},onClick:()=>{var t;e.addPage({bleed:(null===(t=e.activePage)||void 0===t?void 0:t.bleed)||0})},minimal:!0}))),f.animationsEnabled&&n.createElement(A,{store:e}))))});