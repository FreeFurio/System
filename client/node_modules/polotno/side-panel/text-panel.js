var e=this&&this.__rest||function(e,t){var o={};for(var n in e){Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(o[n]=e[n])}if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++){t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(o[n[i]]=e[n[i]])}}return o};import t from"react";import{observer as o}from"mobx-react-lite";import{Button as n,Tab as i,Tabs as l}from"@blueprintjs/core";import a from"swr";import{Upload as r,Trash as s}from"@blueprintjs/icons";import{t as c}from"../utils/l10n.js";import m from"../utils/styled.js";import{isMobile as d}from"../utils/screen.js";import{ImagesGrid as f}from"./images-grid.js";import{textTemplateList as p}from"../utils/api.js";import{fetcher as g}from"../utils/use-api.js";import{registerNextDomDrop as y}from"../canvas/page.js";const h=m("div")`
  height: calc(100% - 40px);
  display: flex;
  flex-direction: column;

  .bp5-dark & .polotno-text-preview-plain {
    filter: invert(1);
  }
`,u=m("div")`
  height: 100px;
  cursor: pointer;
  box-shadow: 0 0 5px rgba(16, 22, 26, 0.3);
  border-radius: 5px;
  background-color: rgba(0, 0, 0, 0.4);
  position: relative;
  font-size: 25px;
  display: flex;
  justify-content: center;
  align-content: center;
  flex-direction: column;
  text-align: center;
  color: white;
  margin-bottom: 10px;
`,x=e=>new Promise((t,o)=>{const n=new FileReader;n.readAsDataURL(e),n.onload=()=>t(n.result),n.onerror=e=>o(e)}),b=o(({onSelect:e,onRemove:o,font:i})=>t.createElement(u,{style:{fontFamily:i.fontFamily},className:"polotno-font-item",onClick:e},i.fontFamily," text",t.createElement(n,{style:{position:"absolute",right:0,bottom:0},minimal:!0,icon:t.createElement(s,null),onClick:e=>{e.stopPropagation(),o()}}))),v=o=>{var{onSelect:i}=o,l=e(o,["onSelect"]);return t.createElement(n,Object.assign({},l,{draggable:!0,className:"polotno-close-panel",onClick:()=>i(),onDragStart:()=>{y(({x:e,y:t})=>{i({x:e,y:t})})},onDragEnd:e=>{y(null)}}))};export const TextPanel=o(({store:e})=>{t.useEffect(()=>{e.loadFont("Roboto")},[]);const o=t=>{var o;const n=t.width||e.width/2,i=((null==t?void 0:t.x)||e.width/2)-n/2,l=((null==t?void 0:t.y)||e.height/2)-t.fontSize/2,a=(e.width+e.height)/2160,r=null===(o=e.activePage)||void 0===o?void 0:o.addElement(Object.assign(Object.assign({type:"text",fontFamily:"Roboto"},t),{x:i,y:l,width:n,fontSize:t.fontSize*a}));d()||null==r||r.toggleEditMode(!0)};t.useEffect(()=>{e.fonts.forEach(t=>e.loadFont(t.fontFamily))},[e.fonts]);const{data:s,error:m}=a(p(),g),[y,u]=t.useState("text");return t.createElement("div",{style:{height:"100%",display:"flex",flexDirection:"column"}},t.createElement(l,{large:!0,onChange:e=>u(e)},t.createElement(i,{id:"text"},c("sidePanel.text")),t.createElement(i,{id:"font"},c("sidePanel.myFonts"))),"text"===y&&t.createElement(h,null,t.createElement(v,{style:{marginBottom:"5px",width:"100%",fontSize:"25px",fontFamily:"Roboto"},minimal:!0,onSelect:e=>{o(Object.assign(Object.assign({},e),{fontSize:76,text:c("sidePanel.headerText"),fontFamily:"Roboto"}))}},c("sidePanel.createHeader")),t.createElement(v,{style:{marginBottom:"5px",width:"100%",fontSize:"18px",fontFamily:"Roboto"},minimal:!0,onSelect:e=>{o(Object.assign(Object.assign({},e),{fontSize:44,text:c("sidePanel.subHeaderText"),fontFamily:"Roboto"}))}},c("sidePanel.createSubHeader")),t.createElement(v,{style:{marginBottom:"5px",width:"100%",fontSize:"14px",fontFamily:"Roboto"},minimal:!0,onSelect:e=>{o(Object.assign(Object.assign({},e),{fontSize:30,text:c("sidePanel.bodyText"),fontFamily:"Roboto"}))}},c("sidePanel.createBody")),t.createElement(f,{shadowEnabled:!1,images:null==s?void 0:s.items,getPreview:e=>e.preview,getImageClassName:e=>e.json.indexOf("plain")>=0?"polotno-text-preview-plain":"",isLoading:!s,error:m,onSelect:async(t,o)=>{const n=await fetch(t.json),i=await n.json();if(!e.activePage){return}const l=(e.width+e.height)/2160,a=o?o.x-i.width/2*l:e.width/2-i.width/2*l,r=o?o.y-i.height/2*l:e.height/2-i.height/2*l;e.history.transaction(()=>{const t=i.pages[0].children,o=[];t.forEach(t=>{var n;delete t.id;const{id:i}=null===(n=e.activePage)||void 0===n?void 0:n.addElement(Object.assign(Object.assign({},t),{fontSize:t.fontSize*l,x:t.x*l+a,y:t.y*l+r,width:t.width*l,height:t.height*l}));o.push(i)}),e.selectElements(o)})}})),"font"===y&&t.createElement("div",{style:{display:"flex",flexDirection:"column",height:"calc(100% - 50px)"}},t.createElement("label",{htmlFor:"polotno-font-upload"},t.createElement(n,{icon:t.createElement(r,null),style:{width:"100%"},onClick:()=>{var e;null===(e=document.querySelector("#polotno-font-upload"))||void 0===e||e.click()}},c("sidePanel.uploadFont")),t.createElement("input",{type:"file",accept:".ttf, .otf, .woff, .woff2, .eot",id:"polotno-font-upload",style:{display:"none"},onChange:async t=>{const{target:o}=t;for(const n of o.files){const t=await x(n),o=n.name.split(".")[0].replace(/,/g,"");e.addFont({fontFamily:o,url:t})}o.value=null}})),t.createElement("div",{style:{paddingTop:"20px",overflow:"auto",height:"100%"}},e.fonts.map((n,i)=>t.createElement(b,{font:n,key:i,onSelect:()=>{o({fontSize:80,text:"Cool text",fontFamily:n.fontFamily})},onRemove:()=>{e.find(e=>{"text"===e.type&&e.fontFamily===n.fontFamily&&e.set({fontFamily:"Roboto"})}),e.removeFont(n.fontFamily)}})))))});