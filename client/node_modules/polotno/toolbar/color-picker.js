var e=this&&this.__rest||function(e,t){var r={};for(var n in e){Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n])}if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++){t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}}return r};import t from"react";import{Tab as r,Tabs as n,Popover as o,NumericInput as l}from"@blueprintjs/core";import{Slider as a}from"@blueprintjs/core";import{observer as s}from"mobx-react-lite";import{t as i}from"../utils/l10n.js";import c from"./sketch.js";import d from"../utils/styled.js";import{parseColor as p,isGradient as u}from"../utils/gradient.js";import{sameColors as g}from"../utils/svg.js";export const DEFAULT_COLORS=["#D0021B","#F5A623","#F8E71C","#8B572A","#7ED321","#417505","#BD10E0","#9013FE","#4A90E2","#50E3C2","#B8E986","#000000","#4A4A4A","#9B9B9B","#FFFFFF"].reverse();export const getUsedColors=e=>{const t=[];e.pages.forEach(e=>{e.children.forEach(e=>{e.shadowEnabled&&t.push(e.shadowColor),"text"===e.type&&(t.push(e.fill),e.backgroundEnabled&&t.push(e.backgroundColor),e.strokeWidth&&t.push(e.stroke)),"svg"===e.type&&t.push(...e.colorsReplace.values()),"figure"===e.type&&(t.push(e.fill),e.strokeWidth&&t.push(e.stroke)),"line"===e.type&&t.push(e.color)})});const r=[];return t.forEach(e=>{if(u(e)){const{stops:t}=p(e);r.push(...t.map(e=>e.color))}else{r.push(e)}}),[...new Set(r)]};const m=d("div")`
  & .sketch-picker {
    padding: 0px !important;
    box-shadow: none !important;
    background: none !important;
  }

  & .flexbox-fix {
    border-top: none !important;
  }

  .bp5-dark & .sketch-picker {
    background-color: #394b59;
  }

  .bp5-dark & .sketch-picker label {
    color: #f5f8fa !important;
  }
`,h=r=>{var{style:n,color:o,onChange:l}=r,a=e(r,["style","color","onChange"]);const[s,i]=t.useState(o);t.useEffect(()=>{i(o)},[o]);const d=t.useRef(),p=t.useRef();return t.createElement(m,{style:n,onMouseDown:e=>{"INPUT"!==e.target.tagName&&e.preventDefault()}},t.createElement(c,Object.assign({color:s},a,{onChange:e=>{const{r:t,g:r,b:n,a:o}=e.rgb,a=`rgba(${t},${r},${n},${o})`;i(a),p.current=a,d.current||(d.current=window.setTimeout(()=>{d.current=0,l(a)},50))}})))},f=e=>e.map(e=>`${e.color} ${100*e.offset}%`).join(","),E=({value:e,onChange:r,store:n,preset:o})=>{const{rotation:s,stops:c}=p(e),d=t.useRef(c);d.current=c;const u=t.useRef(s);u.current=s;const[g,m]=t.useState(0),E=t.useRef(null),b=t.useRef(!1),x=()=>{b.current=!0};return t.useEffect(()=>{var e;null===(e=E.current)||void 0===e||e.focus()},[]),t.useEffect(()=>{const e=e=>{if(b.current){const t=E.current.getBoundingClientRect(),n=e.clientX-t.left,o=n/t.width,l=o<-.5||o>1.5;if(c.length>2&&l){return m(0),b.current=!1,d.current.splice(g,1),void r(`linear-gradient(${u.current}deg, ${f(d.current)})`)}const a=Math.min(1,Math.max(0,n/t.width)),s=[...d.current];s[g].offset=a,r(`linear-gradient(${u.current}deg, ${f(s)})`)}},t=()=>{b.current=!1};return window.addEventListener("mousemove",e),window.addEventListener("mouseup",t),()=>{window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",t)}},[g,d]),t.createElement("div",null,t.createElement("div",{style:{width:"calc(100% - 35px)",height:"60px",position:"relative"}},t.createElement("div",{ref:E,tabIndex:0,style:{position:"absolute",top:0,left:0,width:"100%",marginLeft:"15px",height:"100%",zIndex:0,outline:"none"},onKeyDownCapture:e=>{if("Backspace"===e.key){if(e.preventDefault(),e.stopPropagation(),d.current.length<=2){return}d.current.splice(g,1),r(`linear-gradient(${u.current}deg, ${f(d.current)})`)}},onMouseDown:e=>{const t=e.currentTarget.getBoundingClientRect(),n=e.clientX-t.left,o=Math.min(1,Math.max(0,n/t.width)),l=c[0].color;c.push({color:l,offset:o}),c.sort((e,t)=>e.offset-t.offset);const a=c.findIndex(e=>e.offset===o);m(a),x(),r(`linear-gradient(${s}deg, ${f(c)})`)}}),c.map(({offset:e,color:r},n)=>t.createElement("div",{key:n,style:{position:"absolute",top:"10px",left:100*e+"%",border:n===g?"2px solid rgb(0, 161, 255)":"2px solid rgb(0, 0, 0, 0)",padding:"2px"},onMouseDown:e=>{e.stopPropagation(),m(n),x()}},t.createElement(v,{background:r,style:{margin:0}})))),t.createElement("div",{style:{width:"calc(100% - 30px)",height:"10px",marginLeft:"15px",background:`linear-gradient(90deg,${f(c)})`}}),t.createElement("div",{style:{padding:"10px"}},t.createElement("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",paddingTop:"5px",paddingBottom:"5px"}},t.createElement("div",null,i("toolbar.colorPicker.angle")),t.createElement("div",null,t.createElement(l,{value:s,onValueChange:e=>{const t=Math.min(360,Math.max(0,e));r(`linear-gradient(${t}deg,${f(c)})`)},buttonPosition:"none",style:{width:"50px"},min:0,max:360}))),t.createElement(a,{min:0,max:360,value:s,showTrackFill:!1,labelRenderer:!1,onChange:e=>{r(`linear-gradient(${e}deg,${f(c)})`)}})),t.createElement(h,{color:c[g].color,presetColors:o,onChange:e=>{const t=[...c];t[g].color=e,r(`linear-gradient(${s}deg, ${f(t)})`)}}))},b=s(({value:e,onChange:o,preset:l,store:a})=>{const[s,c]=t.useState(u(e)?"gradient":"solid");return t.createElement("div",{style:{padding:"5px"}},t.createElement(n,{id:"TabsExample",selectedTabId:s,onChange:e=>c(e),renderActiveTabPanelOnly:!0},t.createElement(r,{id:"solid",title:i("toolbar.colorPicker.solid"),panel:t.createElement(h,{color:e,onChange:o,presetColors:l,style:{padding:"0"}})}),t.createElement(r,{id:"gradient",title:i("toolbar.colorPicker.linear"),panel:t.createElement(E,{value:e,onChange:o,store:a,preset:l}),panelClassName:"ember-panel"})))}),v=r=>{var{size:n=30,background:o,style:l={},children:a=null}=r,s=e(r,["size","background","style","children"]);return t.createElement("div",Object.assign({onMouseDown:e=>e.preventDefault(),style:Object.assign({width:n+"px",height:n+"px",background:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='15' height='15' viewBox='0 0 8 8'%3E%3Cg fill='rgba(112, 112, 116, 1)' fill-opacity='1'%3E%3Cpath fill-rule='evenodd' d='M0 0h4v4H0V0zm4 4h4v4H4V4z'/%3E%3C/g%3E%3C/svg%3E\")",borderRadius:"2px",boxShadow:"0 0 2px grey",marginBottom:"-4px"},l)},s),t.createElement("div",{style:{width:n+"px",height:n+"px",background:o}},a))};let x=e=>{const t=getUsedColors(e).slice(0,8).filter(e=>!DEFAULT_COLORS.find(t=>g(t,e)));return t.concat(DEFAULT_COLORS.slice(0,16-t.length).reverse())};export function setColorsPresetFunc(e){x=e}export const ColorPicker=({value:e,onChange:r,size:n,store:l,gradientEnabled:a,children:s,style:i,position:c="auto",onOpen:d,onClose:p})=>{const u=x(l);return t.createElement(o,{autoFocus:!1,enforceFocus:!0,interactionKind:"click",hasBackdrop:!0,position:c,onOpening:d,onClosed:p,content:a?t.createElement(b,{preset:u,value:e,onChange:r,store:l}):t.createElement("div",{style:{padding:"5px"}},t.createElement(h,{color:e,onChange:r,presetColors:u}))},t.createElement(v,{size:n,background:e,style:i},s))};export default ColorPicker;