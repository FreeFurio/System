import e from"react";import{observer as t}from"mobx-react-lite";import{Button as n,ButtonGroup as o}from"@blueprintjs/core";import{Bold as l,Italic as i,Underline as r,Strikethrough as a,AlignLeft as c,AlignCenter as m,AlignRight as s,AlignJustify as p}from"@blueprintjs/icons";import{ElementContainer as d,extendToolbar as u}from"./element-container.js";import x from"./color-picker.js";import f from"./filters-picker.js";import g from"@meronex/icons/md/MdFormatTextdirectionRToL.js";import b from"@meronex/icons/md/MdFormatTextdirectionLToR.js";import h from"@meronex/icons/mdc/MdcFormatVerticalAlignTop.js";import E from"@meronex/icons/mdc/MdcFormatVerticalAlignCenter.js";import T from"@meronex/icons/mdc/MdcFormatVerticalAlignBottom.js";import F from"@meronex/icons/mdc/MdcFormatListBulleted.js";import v from"@meronex/icons/mdc/MdcFormatListNumbered.js";import{AnimationsPicker as j}from"./animations-picker.js";import{flags as y}from"../utils/flags.js";import{TextAiWrite as D}from"./text-ai-write.js";import{quillRef as S,createQuill as w,setQuillContent as A}from"../canvas/html-element.js";import{TextFontFamily as G,TextSpacing as k,TextFontSize as C,TextTransform as M}from"./text-toolbar.js";const _=({html:e})=>{const t=document.createElement("div");document.body.appendChild(t),t.style.display="none",t.style.whiteSpace="pre-wrap";const n=w(t);return A(n,e),n},L=e=>{e.root.parentElement.remove()},W=["left","center","right","justify"],N=["top","middle","bottom"],O={top:e.createElement("span",{className:"bp5-icon"},e.createElement(h,null)),middle:e.createElement("span",{className:"bp5-icon"},e.createElement(E,null)),bottom:e.createElement("span",{className:"bp5-icon"},e.createElement(T,null))},B=t(({active:t,globalActive:o,format:l,element:i,disableGlobal:r,enableGlobal:a,icon:c})=>e.createElement(n,{minimal:!0,icon:c,active:t,onMouseDown:e=>{e.preventDefault()},onClick:e=>{let t=window.__polotnoQuill;if(t){const e=t.getSelection();return t.formatText(e.index,e.length,l,!S.currentFormat[l],"user"),void(o&&r())}t=_({html:i.text}),t.setSelection(0,t.getLength(),"api"),t.format(l,!1);const n=t.root.innerHTML;L(t),i.set({text:n}),o?r():a()}}));export const TextBold=t(({element:t,store:n})=>e.createElement(B,{format:"bold",active:S.currentFormat.bold||"bold"===t.fontWeight||"700"===t.fontWeight,globalActive:"bold"===t.fontWeight||"700"===t.fontWeight,element:t,disableGlobal:()=>t.set({fontWeight:"normal"}),enableGlobal:()=>t.set({fontWeight:"bold"}),icon:e.createElement(l,null)}));export const FontStyleGroup=t(({element:t,store:l,elements:d,components:u})=>{const x=(null==u?void 0:u.TextBold)||TextBold;return e.createElement(o,null,e.createElement(x,{element:t,store:l}),e.createElement(B,{format:"italic",active:S.currentFormat.italic||"italic"===t.fontStyle,globalActive:"italic"===t.fontStyle,element:t,disableGlobal:()=>t.set({fontStyle:"normal"}),enableGlobal:()=>t.set({fontStyle:"italic"}),icon:e.createElement(i,null)}),e.createElement(B,{format:"underline",active:S.currentFormat.underline||t.textDecoration.indexOf("underline")>=0,globalActive:t.textDecoration.indexOf("underline")>=0,element:t,disableGlobal:()=>{let e=t.textDecoration.split(" ");e=e.filter(e=>"underline"!==e),t.set({textDecoration:e.join(" ")})},enableGlobal:()=>{let e=t.textDecoration.split(" ");e.push("underline"),t.set({textDecoration:e.join(" ")})},icon:e.createElement(r,null)}),e.createElement(B,{format:"strike",active:S.currentFormat.strike||t.textDecoration.indexOf("line-through")>=0,globalActive:t.textDecoration.indexOf("line-through")>=0,element:t,disableGlobal:()=>{let e=t.textDecoration.split(" ");e=e.filter(e=>"line-through"!==e),t.set({textDecoration:e.join(" ")})},enableGlobal:()=>{let e=t.textDecoration.split(" ");e.push("line-through"),t.set({textDecoration:e.join(" ")})},icon:e.createElement(a,null)}),e.createElement(n,{minimal:!0,icon:"left"===t.align?e.createElement(c,null):"center"===t.align?e.createElement(m,null):"right"===t.align?e.createElement(s,null):e.createElement(p,null),onClick:()=>{const e=(W.indexOf(t.align)+1+W.length)%W.length,n=W[e];l.history.transaction(()=>{d.forEach(e=>{e.set({align:n})})})}}),y.textVerticalResizeEnabled&&e.createElement(n,{minimal:!0,icon:O[t.verticalAlign],onClick:()=>{const e=(N.indexOf(t.verticalAlign)+1+N.length)%N.length,n=N[e];l.history.transaction(()=>{t.set({verticalAlign:n})})}}),e.createElement(n,{minimal:!0,icon:"bullet"===S.currentFormat.list?e.createElement("span",{className:"bp5-icon"},e.createElement(v,{style:{width:"20px",height:"20px"}})):e.createElement("span",{className:"bp5-icon"},e.createElement(F,{style:{width:"20px",height:"20px"}})),onMouseDown:e=>{e.preventDefault()},onClick:()=>{let e=window.__polotnoQuill,n=!e;e=e||_({html:t.text}),n&&e.setSelection(0,e.getLength(),"api");const o=e.getFormat();o.list?"bullet"===o.list?e.format("list","ordered"):e.format("list",!1):e.format("list","bullet"),n&&(t.set({text:e.root.innerHTML}),L(e))}}))});export const FontColorInput=t(({element:t,store:n})=>{const[o,l]=e.useState(null);return e.createElement(x,{value:S.currentFormat.color||t.fill,gradientEnabled:!0,onOpen:()=>{const e=window.__polotnoQuill;e&&l(e.getSelection())},onClose:()=>{const e=window.__polotnoQuill;e&&e.setSelection(o)},onChange:e=>{const n=window.__polotnoQuill,l=(null==n?void 0:n.getSelection())||o;if(!l){var i=t.text.replace(/style=".*?"/g,"");return void t.set({fill:e,text:i})}const r=(null==l?void 0:l.length)>=(null==n?void 0:n.getLength())-1;n&&!r&&(null==l?void 0:l.length)?n.formatText(l.index,l.length,"color",e,"user"):(i=t.text.replace(/style=".*?"/g,""),t.set({fill:e,text:i}))},store:n})});export const DirectionInput=t(({element:t})=>{const o="rtl"===t.dir?g:b;return e.createElement(n,{icon:e.createElement(o,{className:"bp5-icon",style:{fontSize:"20px"}}),minimal:!0,onClick:()=>{t.set({dir:"rtl"===t.dir?"ltr":"rtl"})}})});const V={TextFontFamily:G,TextFontSize:C,TextFontVariant:FontStyleGroup,TextTransform:M,TextFilters:f,TextFill:FontColorInput,TextSpacing:k,TextDirection:DirectionInput,TextAnimations:j,TextAiWrite:D};export const HtmlToolbar=t(({store:t,components:n})=>{const o=t.selectedElements,l=t.selectedElements[0],i=["TextFill","TextFontFamily","TextFontSize","TextFontVariant","TextSpacing","TextTransform","TextFilters",y.animationsEnabled&&"TextAnimations","TextAiWrite"],r=u({type:"text",usedItems:i,components:n});return e.createElement(d,{items:r,itemRender:i=>{if("TextBold"===i){return null}const r=n[i]||V[i];return e.createElement(r,{element:l,elements:o,store:t,key:i,components:n})}})});