import e from"react";import{observer as t}from"mobx-react-lite";import{ElementContainer as o,extendToolbar as i}from"./element-container.js";import{Button as n,Popover as r,NumericInput as a,Navbar as l,NavbarGroup as s,Slider as m}from"@blueprintjs/core";import{AnimationsPicker as c}from"./animations-picker.js";import{flags as d}from"../utils/flags.js";import{getVideoDuration as p,getVideoObjectPreview as u,getVideoSize as h}from"../utils/video.js";import{t as g}from"../utils/l10n.js";import{Cut as v,VolumeUp as w}from"@blueprintjs/icons";export const VideoTrim=t(({store:t,components:o,element:i})=>{const m=e.useRef(null),[c,d]=e.useState([]);e.useEffect(()=>{d([])},[i.src]);const g=(e,t)=>{e.preventDefault();const o=e=>{e.preventDefault();const{clientX:o}=e,{left:n,width:r}=m.current.getBoundingClientRect(),{src:a}=i,l=(o-n)/r;"start"===t?i.set({startTime:Math.min(i.endTime,Math.max(0,l))}):"end"===t&&i.set({endTime:Math.min(1,Math.max(i.startTime,l))})};window.addEventListener("mousemove",o),window.addEventListener("mouseup",()=>{window.removeEventListener("mousemove",o)})};return e.createElement(r,{position:"bottom",onOpened:async()=>{if(!i.src){return}if(c.length){return}const{width:e,height:t}=await h(i.src),o=e/t,{src:n}=i,r=m.current.offsetHeight,a=m.current.offsetWidth,l=r*o,s=Math.ceil(a/l),g=await p(n),v=document.createElement("video");v.crossOrigin="anonymous",v.src=n;const w=document.createElement("canvas");w.width=480;try{await new Promise((e,t)=>{v.addEventListener("loadeddata",()=>{const t=v.videoWidth/v.videoHeight;w.height=480/t,e()}),v.addEventListener("error",t)}),d([]);for(let e=0;e<s;e++){const t=e*g/s,o=await u(v,w,t);d(e=>e.concat(o))}}catch(x){console.error("Error generating previews:",x)}},content:e.createElement(l,{style:{boxShadow:"none",backgroundColor:"transparent",width:"calc(100vw - 300px)"}},e.createElement(s,null,e.createElement(a,{style:{width:"80px"},value:parseFloat((i.duration*(i.endTime-i.startTime)/1e3).toFixed(2)),minorStepSize:.01,stepSize:.1,buttonPosition:"none",readOnly:!0}),e.createElement("div",{style:{width:"calc(100vw - 420px)",height:"30px",display:"flex",position:"relative",overflow:"hidden",marginLeft:"10px"},ref:m},c.map((t,o)=>e.createElement("img",{key:o,src:t,style:{width:"auto",height:"100%",objectFit:"cover"}})),e.createElement("div",{style:{position:"absolute",top:"0",left:0,width:100*i.startTime+"%",height:"30px",backgroundColor:"rgb(0, 0, 0, 0.5)"}}),e.createElement("div",{style:{position:"absolute",top:"0",right:"0%",width:100-100*i.endTime+"%",height:"30px",backgroundColor:"rgb(0, 0, 0, 0.5)"}}),e.createElement("div",{style:{position:"absolute",top:"0",left:100*i.startTime+"%",width:"10px",height:"30px",borderRadius:"0px",backgroundColor:"rgb(0, 161, 255, 0.9)",cursor:"ew-resize"},onMouseDown:e=>{g(e,"start")}}),e.createElement("div",{style:{position:"absolute",top:"0",right:100-100*i.endTime+"%",width:"10px",height:"30px",borderRadius:"0px",backgroundColor:"rgb(0, 161, 255, 0.9)",cursor:"ew-resize"},onMouseDown:e=>{g(e,"end")}}))))},e.createElement(n,{icon:e.createElement(v,null),minimal:!0},"Trim"))});const x=t(({element:t})=>{const o=Math.round(100*t.volume),i=e=>{t.set({volume:e/100})};return e.createElement(r,{position:"bottom",content:e.createElement("div",{style:{padding:"10px",width:"250px"}},e.createElement("div",{style:{display:"flex",width:"100%",justifyContent:"space-between"}},e.createElement("div",{style:{paddingTop:"7px",paddingLeft:"10px",width:"calc(100% - 80px)"}},e.createElement(m,{value:o,onChange:e=>{i(e)},min:0,max:100,labelStepSize:50,showTrackFill:!1,labelRenderer:!1})),e.createElement(a,{value:o,onValueChange:e=>{var t;i((t=e,Math.max(0,Math.min(100,t))))},buttonPosition:"none",style:{width:"50px",padding:"0 5px",marginLeft:"10px"},min:0,max:100})))},e.createElement(n,{icon:e.createElement(w,null),minimal:!0}))});export const VideoClip=t(({element:t,store:o})=>t.contentEditable?t.clipSrc?e.createElement(n,{text:g("toolbar.removeClip"),minimal:!0,onClickCapture:e=>{t.set({clipSrc:""})}}):e.createElement(n,{minimal:!0,text:g("toolbar.clip"),onClickCapture:e=>{e.stopPropagation(),o.openSidePanel("image-clip")}}):null);const E={VideoTrim,VideoAnimations:c,VideoVolume:x,VideoClip};export const VideoToolbar=t(({store:t,components:n})=>{const r=t.selectedElements,a=["VideoTrim","VideoVolume","VideoClip",d.animationsEnabled&&"VideoAnimations"].filter(e=>!!e),l=i({type:"video",usedItems:a,components:n});return e.createElement(o,{items:l,itemRender:o=>{const i=n[o]||E[o];return e.createElement(i,{elements:r,element:r[0],store:t,key:o})}})});export default VideoToolbar;