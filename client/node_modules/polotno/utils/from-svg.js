import t from"konva";import{getImageSize as e,getCrop as n}from"./image.js";let i=0;const r=()=>(i+=1,i.toString());function o(t){const e=t.getAttribute("viewBox"),[n,i,r,o]=(null==e?void 0:e.split(" "))||[];return(!t.getAttribute("width")||t.getAttribute("width").indexOf("%")>=0)&&t.setAttribute("width",r+"px"),(!t.getAttribute("height")||t.getAttribute("height").indexOf("%")>=0)&&t.setAttribute("height",o+"px"),{width:parseFloat(t.getAttribute("width")||r),height:parseFloat(t.getAttribute("height")||o)}}function g(e){const n=function(e){var n,i,r;const o=(null===(r=null===(i=null===(n=e.transform)||void 0===n?void 0:n.baseVal)||void 0===i?void 0:i.consolidate())||void 0===r?void 0:r.matrix)||new DOMMatrix;return new t.Transform([o.a,o.b,o.c,o.d,o.e,o.f])}(e);return e.parentNode&&"svg"!==e.parentNode.nodeName?g(e.parentNode).multiply(n):n}function s(t){return g(t).decompose()}function a(t){const{x:e,y:n}=t.getBoundingClientRect();if("svg"===t.nodeName){return{x:e,y:n}}const i=a(t.parentNode);return{x:e+i.x,y:n+i.y}}function l(t){return t.getElementsByTagName("text").length>0}function u(t){const e=[...t.getElementsByTagName("rect")].find(t=>{const e=t.getAttribute("fill");return e&&e.indexOf("url")>=0});return t.getElementsByTagName("image").length>0||e}export function svgToURL(t){return"data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(t)))}function h(t="url(#pattern)"){return t.replace(/url\(([^)]+)\)/,"$1").replace(/'/g,"")}function d(t){if(!t){return"Roboto"}if(t.includes("OpenSans")){return"Open Sans"}if(t.includes("Montserrat")){return"Montserrat"}const e=t.split(",").map(t=>t.trim());return e[1]||e[0]}function c(t){return t.parentNode&&"svg"===t.parentNode.nodeName?t.parentNode:c(t.parentElement)}async function f(t){if("defs"===t.nodeName){return[]}const i=t.getAttribute("id")||r();if("text"===t.nodeName){let e=Array.from(t.children).map(t=>t.textContent);0===e.length&&(e=[t.textContent]);const n=e.join("\n"),r=parseFloat(t.getAttribute("font-size")||t.style.fontSize||"20"),{x:o,y:g,rotation:a}=s(t),l=t.getAttribute("text-anchor")||"start";let u="left";return"middle"===l?u="center":"end"===l&&(u="right"),[{type:"text",text:n,id:i,x:o+t.getBBox().x,y:g+t.getBBox().y,fontSize:r,rotation:a,lineHeight:t.getBBox().height/e.length/r,width:t.getBBox().width,height:t.getBBox().height,fontFamily:d(t.getAttribute("font-family")),fontWeight:t.getAttribute("font-weight")||"normal",fontStyle:t.getAttribute("font-style")||"normal",align:u,fill:t.getAttribute("fill")||t.style.fill||"black"}]}if("image"===t.nodeName){const{x:r,y:o,rotation:g,scaleX:a,scaleY:l}=s(t),u=t.getBBox().width*a,h=t.getBBox().height*l,d=t.getAttribute("xlink:href")||"",c=await e(d),f=n({width:u,height:h},c);return[Object.assign({type:"image",id:i,x:r+t.getBBox().x,y:o+t.getBBox().y,width:u,height:h,src:d,rotation:g},f)]}if("rect"===t.nodeName){const{x:r,y:o,rotation:g}=s(t),a=parseFloat(t.getAttribute("width")||"0"),l=parseFloat(t.getAttribute("height")||"0"),u=t.getAttribute("fill")||"",d=u.indexOf("url")>=0,c=d&&h(u),f=document.querySelector(c);if(d){const s=null==f?void 0:f.querySelector("use"),u=null==s?void 0:s.getAttribute("xlink:href"),h=u&&document.querySelector(u);if(h){const s=h.getAttribute("xlink:href"),u=await e(s),d=n({width:a,height:l},u);return[Object.assign({type:"image",id:i,x:r+t.getBBox().x,y:o+t.getBBox().y,width:a,height:l,src:s,rotation:g},d)]}}t.setAttribute("transform","");const x=t.getBBox();t.setAttribute("x","0"),t.setAttribute("y","0");const m=`<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="${a}" height="${l}" viewBox="0 0 ${a} ${l}">${(null==f?void 0:f.outerHTML)||""}${t.outerHTML}</svg>`;return[{type:"svg",id:i,x:r+x.x,y:o+x.y,width:a,height:l,src:svgToURL(m)}]}if("path"===t.nodeName||"polygon"===t.nodeName||"circle"===t.nodeName){const{x:e,y:n,rotation:r,scaleX:o,scaleY:g}=s(t),a=t.getBBox(),{width:l,height:u}=a;t.setAttribute("transform","");const d=t.getAttribute("fill")||"",c=d.indexOf("url")>=0&&h(d),f=document.querySelector(c);let x=f?[f]:[];if(f&&f.getAttribute("xlink:href")){x=[f];const t=document.querySelector(f.getAttribute("xlink:href"));t&&x.push(t)}const m=`<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="${l}" height="${u}" viewBox="0 0 ${l} ${u}"><defs>${x.map(t=>t.outerHTML).join("")}</defs><g transform="translate(${-a.x} ${-a.y})">${t.outerHTML}</g></svg>`;return[{type:"svg",id:i,x:e+a.x*o,y:n+a.y*g,width:l*o,height:u*g,rotation:r,src:svgToURL(m)}]}if((t=>"g"===t.nodeName&&t.getBBox().width<450&&t.getBBox().height<450)(t)&&!l(t)&&!u(t)){const{x:e,y:n}=t.getBBox(),{width:r,height:g}=(a(t),t.getBBox()),s=Array.from(t.querySelectorAll("*"));let l=e,u=n;s.forEach(t=>{if("g"===t.nodeName){return}const e=t.getBBox();l=Math.min(l,e.x),u=Math.min(u,e.y)});const h=t.getBoundingClientRect(),d=c(t),f=null==d?void 0:d.getBoundingClientRect(),x=t.getAttribute("transform");t.setAttribute("transform","");const m=`<svg xmlns="http://www.w3.org/2000/svg" width="${r}" height="${g}" viewBox="0 0 ${r} ${g}"><g transform="translate(${-e} ${-n})">${t.outerHTML}</g></svg>`;t.setAttribute("transform",x);const w=o(c(t));return[{type:"svg",id:i,x:(h.x-f.x)/f.width*w.width,y:(h.y-f.y)/f.height*w.height,width:r,height:g,name:t.getAttribute("id")||"",src:svgToURL(m)}]}if(!l(t)&&!u(t)){const e=[];for(const n of Array.from(t.children)){e.push(...await f(n))}return e}const g=[];for(const e of Array.from(t.children)){g.push(...await f(e))}return g}export async function svgToJson(t){const e=document.createElement("div");document.body.appendChild(e),e.innerHTML=t;const n=e.querySelector("svg"),{width:i,height:g}=o(n),s=[];for(const r of Array.from(n.children)){s.push(...await f(r))}return e.parentElement.removeChild(e),{width:i,height:g,pages:[{id:r(),children:s}]}}