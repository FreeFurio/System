import*as t from"rasterizehtml";import{getGoogleFontsVariants as e}from"./fonts.js";import{trySetCanvasSize as n}from"./canvas.js";import{optimizeCss as o}from"./css-optimizer.js";import{resetStyleContent as i,resetStyle as s}from"./reset-style.js";let l;const r=()=>(l||(l=document.createElement("div"),l.id="polotno-hidden-do-not-touch",l.style.overflow="hidden",l.style.position="relative",document.body.appendChild(l),l.innerHTML=`<style>#polotno-hidden-do-not-touch {${i}}</style>`),l),c=new Map,a=navigator.userAgent.includes("Firefox");export const prerenderFont=async t=>{if(c.has(t)){return c.get(t)}const e=(async()=>{const e=`<div style="font-family: ${t}; font-size: 100px;">${t}<strong>${t}</strong></div>`,n=document.createElement("div");n.innerHTML=e,n.style.visibility="hidden",n.style.position="absolute";const o=r();o.appendChild(n);const i=a?180:50;await new Promise(t=>setTimeout(t,i)),o.removeChild(n)})();return c.set(t,e),e};export function isContentWrapping({html:t}){const e=document.createElement("div");e.innerHTML=t,e.style.display="inline-block",e.style.position="fixed",e.style.top="0px",e.style.left="0px",e.style.zIndex="1000",e.style.whiteSpace="nowrap",e.style.visibility="hidden";const n=r();n.appendChild(e);const o=e.textContent,i=e.childNodes[0],s=(null==o?void 0:o.split(/\s+/))||[];let l=!1;for(let r=0;r<s.length;r++){const t=s[r];if(i&&(i.textContent=t,l=i.scrollWidth>e.clientWidth,l)){break}}return n.removeChild(e),l}export function detectSize(t){const e=document.createElement("div");e.innerHTML=t,e.style.display="inline-block",e.style.position="fixed",e.style.top="0px",e.style.left="0px",e.style.zIndex="1000";const n=r();n.appendChild(e);const o=e.getBoundingClientRect();return n.removeChild(e),{width:o.width,height:o.height}}const d={},h={},p=new Map;export async function htmlToCanvas({html:i,width:l,height:r,fontFamily:c,padding:a,font:y,pixelRatio:f}){let m="";if("Arial"!==c&&!y){const t=e();m=await async function(t,e){const n=`${t}|${e}`;if(p.has(n)){return p.get(n)}const o=`https://fonts.googleapis.com/css?family=${t}:${e}&display=swap`,i=await(await fetch(o)).text();return p.set(n,i),i}(c,t)}if(y){const t=y.styles||(y.url?[{src:`url("${y.url}")`}]:(t=>{if(h[t]){return h[t]}const e=function(t){const e=[];for(let o=0;o<document.styleSheets.length;o++){const i=document.styleSheets[o];try{const n=i.cssRules;if(n){for(let o=0;o<n.length;o++){const i=n[o];i instanceof CSSFontFaceRule&&i.style.fontFamily.replace(/['"]/g,"")===t&&e.push(i)}}}catch(n){console.warn(`Could not access stylesheet: ${i.href}`,n)}}return e}(t),n=e.filter(e=>e.style.fontFamily.replace(/['"]/g,"")===t).map(t=>({src:t.style.getPropertyValue("src"),fontStyle:t.style.getPropertyValue("font-style")||"normal",fontWeight:t.style.getPropertyValue("font-weight")||"normal"}));return h[t]=n,n})(c));m="",t.forEach(t=>{m+=`\n      @font-face {\n        font-family: '${c}';\n        src: ${t.src};\n        font-style: ${t.fontStyle||"normal"};\n        font-weight: ${t.fontWeight||"normal"};\n      }\n    `})}let u="";m&&(u=o(m,i)),i+=u+s;const g=l+2*a,w=r+2*a,v=document.createElement("canvas"),x=await t.drawHTML(`<div style="padding: ${a}px;" dir="auto">${i}</div>`,v,{width:g,height:w,cacheBucket:d});n(v,g*f,w*f);const $=v.getContext("2d");return null==$||$.drawImage(x.image,0,0,g,w,0,0,v.width,v.height),v}