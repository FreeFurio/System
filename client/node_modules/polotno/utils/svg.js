import t from"konva";import e from"react";import{parseColor as r,isGradient as o}from"./gradient.js";import n from"mensch";function s(t){for(;t.parentNode;){if("defs"===t.nodeName){return!0}t=t.parentNode}return!1}function l(t){const e={};return t.querySelectorAll("style").forEach(t=>{const r=n.parse(t.textContent).stylesheet.rules;for(let o of r){o.selectors&&o.selectors.forEach(t=>{const r=e[t]||{};o.declarations.forEach(t=>{r[t.name]=t.value}),e[t]=r})}}),e}function i(t,e){var r;const o={fill:"",stroke:""},n=(null===(r=t.getAttribute("class"))||void 0===r?void 0:r.split(" "))||[],s=t.getAttribute("id");let l={};if(s&&e[`#${s}`]?l=e[`#${s}`]:n.forEach(t=>{e[`.${t}`]&&(l=Object.assign(Object.assign({},l),e[`.${t}`]))}),e[t.nodeName]&&(l=Object.assign(Object.assign({},l),e[t.nodeName])),t.getAttribute("fill")&&"none"!==t.getAttribute("fill")?o.fill=t.getAttribute("fill"):l.fill&&"none"!==l.fill&&(o.fill=l.fill),t.getAttribute("stroke")&&"none"!==t.getAttribute("stroke")?o.stroke=t.getAttribute("stroke"):l.stroke&&"none"!==l.stroke&&(o.stroke=l.stroke),!o.fill&&t.style.fill&&"none"!==t.style.fill&&(o.fill=t.style.fill),!o.stroke&&t.style.stroke&&"none"!==t.style.stroke&&(o.stroke=t.style.stroke),!o.stroke&&!o.fill){const r=t.ownerSVGElement,n=r&&r!==t&&i(r,e);"currentColor"===(null==n?void 0:n.fill)||"currentColor"===(null==n?void 0:n.stroke)||(o.fill="black")}return o}const a=["path","rect","circle","line","polygon","polyline","ellipse","text"];function c(t){for(var e=[],r=t.getElementsByTagName("*"),o=0,n=r.length;o<n;o++){const t=r[o];s(t)||(null!==t.getAttribute("fill")&&e.push(t),(null!==t.getAttribute("stroke")||t.style&&t.style.fill||a.indexOf(t.nodeName)>=0)&&e.push(t))}return e}export async function urlToBase64(t){const e=await fetch(t);return svgToURL(await e.text())}export async function urlToString(t){const e=await fetch(t,{mode:"cors"});return await e.text()}export function getColors(e){var r=(new DOMParser).parseFromString(e,"image/svg+xml");const o=l(r),n=c(r),s=[];return n.forEach(e=>{const{fill:r,stroke:n}=i(e,o);[r,n].forEach(e=>{e&&("currentColor"===e&&(e="black"),t.Util.colorToRGBA(e)&&-1===s.indexOf(e)&&s.push(e))})}),s}export function svgToURL(t){return"data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(t)))}export async function getSvgSize(t){const e=await urlToString(t),r=(new DOMParser).parseFromString(e,"image/svg+xml").documentElement.getAttribute("viewBox"),[o,n,s,l]=(null==r?void 0:r.split(" "))||[];return{width:parseFloat(s),height:parseFloat(l)}}export function fixSize(t){var e=(new DOMParser).parseFromString(t,"image/svg+xml");const r=e.documentElement.getAttribute("viewBox"),[o,n,s,l]=(null==r?void 0:r.split(" "))||[],i=e.documentElement.getAttribute("width");!i&&e.documentElement.setAttribute("width",s+"px");const a=e.documentElement.getAttribute("height");if((!a||a.indexOf("%")>=0)&&e.documentElement.setAttribute("height",l+"px"),i&&i.indexOf("%")>=0&&a&&-1===a.indexOf("%")){const t=parseFloat(a)/parseFloat(l);e.documentElement.setAttribute("width",t*parseFloat(s)+"px")}if(a&&a.indexOf("%")>=0&&i&&-1===i.indexOf("%")){const t=parseFloat(i)/parseFloat(s);e.documentElement.setAttribute("height",t*parseFloat(l)+"px")}return"100%"===i&&"100%"===a&&(e.documentElement.setAttribute("width",s+"px"),e.documentElement.setAttribute("height",l+"px")),(new XMLSerializer).serializeToString(e)}export const sameColors=(e,r)=>{if(!e||!r){return!1}if("currentColor"===r&&"black"===e){return!0}const o=t.Util.colorToRGBA(e),n=t.Util.colorToRGBA(r);return o&&n?o.r===n.r&&o.g===n.g&&o.b===n.b&&o.a===n.a:void 0};export function replaceColors(e,n){var s=(new DOMParser).parseFromString(e,"image/svg+xml");const a=c(s),u=Array.from(n.keys()),f=l(s);return a.forEach(e=>{const{fill:l,stroke:a}=i(e,f);[{prop:"fill",color:l},{prop:"stroke",color:a}].forEach(({prop:l,color:i})=>{const a=u.find(t=>sameColors(t,i));if(a){const i=n.get(a);if(o(i)){const{rotation:o,stops:n}=r(i),a=n.map(t=>({offset:100*t.offset+"%","stop-color":t.color})),c="color"+Math.round(1e8*Math.random());!function(e,r,o,n){var s=e.namespaceURI,l=document.createElementNS(s,"linearGradient");const i=t.Util.degToRad(o+90),a=(Math.cos(i)+1)/2,c=(Math.sin(i)+1)/2,u=(Math.cos(i+Math.PI)+1)/2,f=(Math.sin(i+Math.PI)+1)/2;l.setAttribute("x1",100*a+"%"),l.setAttribute("y1",100*c+"%"),l.setAttribute("x2",100*u+"%"),l.setAttribute("y2",100*f+"%"),l.setAttribute("gradientUnits","userSpaceOnUse"),l.setAttribute("id",r);for(var m=0;m<n.length;m++){var p=n[m],d=document.createElementNS(s,"stop");for(var g in p){p.hasOwnProperty(g)&&d.setAttribute(g,p[g])}l.appendChild(d)}(e.querySelector("defs")||e.insertBefore(document.createElementNS(s,"defs"),e.firstChild)).appendChild(l)}(s.children[0],c,o,a),e.style[l]=null,e.setAttribute(l,`url('#${c}')`)}else{e.style[l]=n.get(a)}}})}),svgToURL((new XMLSerializer).serializeToString(s))}export const useSvgColors=t=>{const[r,o]=e.useState([]);return e.useEffect(()=>{let e=!1;return(async()=>{o([]);const r=getColors(await urlToString(t));e||o(r)})(),()=>{e=!0}},[t]),r};