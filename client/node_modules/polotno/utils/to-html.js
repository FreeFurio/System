var e=this&&this.__rest||function(e,t){var o={};for(var i in e){Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(o[i]=e[i])}if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++){t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(o[i[n]]=e[i[n]])}}return o};import{getCrop as t,loadImage as o}from"./image.js";import*as i from"./svg.js";import{figureToSvg as n}from"./figure-to-svg.js";import{resetStyleContent as r}from"./reset-style.js";import{Effects as s,shapeFilterToCSS as a}from"./filters.js";import{getVideoSize as l}from"./video.js";import{getGoogleFontsUrl as h}from"./fonts.js";const p=(e,t,...o)=>({type:e,props:t,children:o||[]});export function fixRatio(e){var t=(new DOMParser).parseFromString(e,"image/svg+xml");return t.documentElement.setAttribute("preserveAspectRatio","none"),(new XMLSerializer).serializeToString(t)}const d=async({element:e,page:t,store:n})=>{let{src:r}=e;if("svg"===e.type&&Object.keys(e.colorsReplace).length){const t=await i.urlToString(r);r=i.replaceColors(t,new Map(Object.entries(e.colorsReplace)))}let s="";e.flipX&&(s+="scaleX(-1)"),e.flipY&&(s+="scaleY(-1)"),s||(s="none");const a={};if(e.clipSrc){const t=await i.urlToBase64(e.clipSrc);a["clip-path"]=`url(${t})`}const l=await o(r),h=l.width*e.cropWidth,d=l.height*e.cropHeight,c=e.width/e.height;let g,u;const m=h/d;"svg"===e.type?(g=h,u=d):c>=m?(g=h,u=h/c):(g=d*c,u=d);const f=g/l.width,b=u/l.height,y=g/u>e.width/e.height?e.height/u:e.width/g,w=g*y/f,x=u*y/b,$=e.cropX*y*l.width,k=e.cropY*y*l.height;return p("div",{style:Object.assign(Object.assign({},a),{width:"100%",height:"100%",borderRadius:e.cornerRadius+"px",border:e.borderSize?`${e.borderSize}px solid ${e.borderColor}`:"none",backgroundRepeat:"no-repeat",backgroundImage:`url(${r})`,transform:s,backgroundSize:`${Math.round(w)}px ${Math.round(x)}px`,backgroundPositionX:-Math.round($)+"px",backgroundPositionY:-Math.round(k)+"px"})})},c=({element:e,type:t})=>{const o={"stroke-width":e.height,stroke:e.color,"line-cap":"round","stroke-linejoin":"round",opacity:e.opacity};return"arrow"===t||"triangle"===t?p("polyline",Object.assign({points:`${3*e.height},${2*-e.height} 0,0 ${3*e.height},${2*e.height}`},o)):"bar"===t?p("polyline",Object.assign({points:`0,${2*-e.height} 0,${2*e.height}`},o)):"circle"===t?p("circle",Object.assign({r:e.height},o)):"square"===t?p("polyline",Object.assign({points:`${-e.height},${-e.height} ${-e.height},${e.height} ${e.height},${e.height} ${e.height},${-e.height}`},o)):null},g={image:d,svg:d,text:async({element:e,page:t,store:o})=>{let i={top:0,left:0};e.fill.indexOf("gradient")>=0&&(i=Object.assign(Object.assign({},i),{backgroundColor:e.fill,backgroundImage:e.fill,backgroundClip:"text",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}));const n=e.backgroundPadding*(e.fontSize*e.lineHeight),s=p("div",{style:{position:"absolute",top:-n/2+"px",left:-n/2+"px",display:e.backgroundEnabled?"block":"none",width:e.width+n+"px",height:e.height+n+"px",backgroundColor:e.backgroundColor,borderRadius:e.backgroundCornerRadius*(e.fontSize*e.lineHeight*.5)+"px"}});"middle"===e.verticalAlign?(i.top="50%",i.transform="translateY(-50%)"):"bottom"===e.verticalAlign&&(i.bottom=0);const a=/<[a-z][\s\S]*>/i.test(e.text),l=Object.assign(Object.assign({},i),{position:"absolute",width:e.width+"px",color:e.fill,whiteSpace:"pre-wrap",fontSize:e.fontSize+"px",textAlign:e.align,fontFamily:e.fontFamily,textDecoration:e.textDecoration||"none",textTransform:e.textTransform||"none",lineHeight:e.lineHeight,letterSpacing:e.letterSpacing+"em",fontStyle:e.fontStyle,fontWeight:e.fontWeight,WebkitTextStroke:`${e.strokeWidth}px ${e.stroke}`,textStroke:`${e.strokeWidth}px ${e.stroke}`}),h="el-"+e.id,d=a?{id:h}:{},c=`<style>#${h} {${r}}</style>`,g=p("div",Object.assign(Object.assign({style:l},d),{innerHTML:a?`${c}${e.text}`:e.text.split("\n").join("<br />")}));return p("div",{style:{position:"relative",width:"100%",height:"100%"}},s,g)},line:async({element:e,page:t,store:o})=>p("svg",{style:{width:"100%",height:"100%",contain:"layout style size",overflow:"visible"}},p("rect",{x:0,y:0,width:e.width,height:e.height,fill:e.color}),p("g",{transform:`translate(0 ${e.height/2})`},c({element:e,type:e.startHead})),p("g",{transform:`translate(${e.width} ${e.height/2}) rotate(180)`},c({element:e,type:e.endHead}))),figure:async({element:e,page:t,store:o,elementHook:i})=>{const r=n(e),s=p("div",{innerHTML:r});return i&&i({dom:s,element:e})||s},group:async({element:e,page:t,store:o,elementHook:i})=>{const n=await Promise.all(e.children.map(e=>u({element:e,page:t,store:o,elementHook:i}))),r=p("div",{style:{transformOrigin:"top left",opacity:e.opacity}},...n);return i&&i({dom:r,element:e})||r},video:async({element:e,page:t,store:o,elementHook:i})=>{const{cropX:n,cropY:r,cropWidth:s,cropHeight:a}=e,h=await l(e.src),d=h.width*s,c=h.height*a,g=e.width/e.height;let u,m;g>=d/c?(u=d,m=d/g):(u=c*g,m=c);const f=u/s,b=m/a,y=n*h.width,w=r*h.height,x=Math.max(e.width/h.width,e.height/h.height),$={position:"absolute",width:`${Math.round(f*x)}px`,height:`${Math.round(b*x)}px`,left:-Math.round(y*x)+"px",top:-Math.round(w*x)+"px",objectFit:"fill"},k=`video-${e.id}`,j=p("div",{style:{position:"relative",width:"100%",height:"100%",overflow:"hidden",borderRadius:e.cornerRadius+"px",border:e.borderSize?`${e.borderSize}px solid ${e.borderColor}`:"none"}},p("video",{id:k,src:e.src,style:$,controls:!0,playsInline:!0,muted:!0,volume:e.volume}));return i&&i({dom:j,element:e})||j},gif:d};async function u({element:e,page:t,store:o,elementHook:i}){let n=await g[e.type];if(n||(n=()=>p("div",{}),console.error(`HTML export does not support ${e.type} type...`)),!e.visible){return null}const r=await n({element:e,page:t,store:o}),l=[],h=[];if(e.blurEnabled&&l.push(`blur(${e.blurRadius/2}px)`),e.brightnessEnabled&&l.push(`brightness(${100*e.brightness+100}%)`),e.sepiaEnabled&&l.push("sepia()"),e.grayscaleEnabled&&l.push("grayscale()"),e.filters){for(const[p,c]of Object.entries(e.filters)){const e=a(s[p],c.intensity);e&&(l.push(e.filter),e.html&&h.push(e.html))}}e.shadowEnabled&&l.push(`drop-shadow(${e.shadowOffsetX}px ${e.shadowOffsetY}px ${e.shadowBlur}px ${e.shadowColor})`);const d=p("div",{id:e.id,style:{position:"absolute",left:e.x+"px",top:e.y+"px",width:e.width+"px",height:e.height+"px",transform:`rotate(${e.rotation}deg)`,transformOrigin:"top left",opacity:e.opacity,display:e.visible&&e.showInExport?"block":"none",filter:l.join(" ")||"none"}},r,...h);return i&&i({dom:d,element:e})||d}export async function jsonToDOM({json:e,elementHook:i}){const n=await Promise.all(e.pages.map(n=>async function({page:e,store:i,elementHook:n}){const r=await Promise.all(e.children.map(t=>u({element:t,page:e,store:i,elementHook:n}))),s="auto"===e.width?i.width:e.width,a="auto"===e.height?i.height:e.height;let l={};if(e.background.indexOf("url")>=0||e.background.indexOf("http")>=0||e.background.indexOf(".jpg")>=0||e.background.indexOf(".png")>=0||e.background.indexOf(".jpeg")>=0){const{width:n,height:l}=await o(e.background),h=await d({element:Object.assign({x:0,y:0,width:s,height:a,src:e.background,cornerRadius:0},t({width:s,height:a},{width:n,height:l})),page:e,store:i});r.unshift(h)}else{l=Object.assign(Object.assign({},l),{backgroundColor:e.background})}return p("div",{className:"page",id:e.id,style:Object.assign(Object.assign({},l),{width:s+"px",height:a+"px",overflow:"hidden",position:"relative"})},...r)}({page:n,store:e,elementHook:i}))),r=[];e.pages.forEach(e=>{e.children.forEach(e=>{"text"===e.type&&-1===r.indexOf(e.fontFamily)&&r.push(e.fontFamily)})});const s=r.map(t=>e.fonts.find(e=>e.fontFamily===t)?p("style",{},""):p("link",{href:h(t),rel:"stylesheet"}));return p("div",{className:"design"},...s,...n)}const m=({dom:t})=>{if("string"==typeof t){return t}if(!t){return""}const o=t.props,{innerHTML:i}=o,n=e(o,["innerHTML"]),r=Object.keys(n).map(e=>"style"===e&&"object"==typeof n[e]?`style="${Object.keys(n[e]).map(t=>`${t.replace(/[A-Z]/g,e=>`-${e.toLowerCase()}`)}: ${n[e][t]}`).join("; ")}"`:((e,t)=>"object"==typeof t?`${e}="${Object.keys(t).map(e=>`${e.replace(/-([a-z])/g,e=>e[1].toUpperCase())}:${t[e]};`).join(" ")}"`:`${e}="${t}"`)(e,n[e])).join(" ");return`<${t.type} ${r}>${i||t.children.map(e=>m({dom:e})).join("")}</${t.type}>`};export async function jsonToHTML({json:e,elementHook:t}){const o=await jsonToDOM({json:e,elementHook:t});return m({dom:o})}