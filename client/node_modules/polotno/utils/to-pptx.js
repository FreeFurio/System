import{loadImage as t,cropImage as e}from"./image.js";import*as a from"./svg.js";import{figureToSvg as o}from"./figure-to-svg.js";import{removeTags as i}from"./text.js";import{pxToUnit as n}from"./unit.js";import r from"konva";const s=t=>n({px:t,unit:"in",dpi:100}),d=t=>Math.round(100*(1-t)),c=t=>{const{dx:e,dy:a}=((t,e,a)=>{const o=(a%360+360)%360;if(0===o){return{dx:0,dy:0}}const i=o*Math.PI/180,n=t/2,r=e/2;return{dx:n*Math.cos(i)-r*Math.sin(i)-n,dy:n*Math.sin(i)+r*Math.cos(i)-r}})(t.width,t.height,t.rotation);return{x:s(t.x+e),y:s(t.y+a)}},h=t=>{if(!t){return"000000"}if(/^[0-9a-fA-F]{6}$/.test(t)){return t.toLowerCase()}let e=r.Util.colorToRGBA(t);return!e&&/^[0-9a-fA-F]{3,6}$/.test(t)&&(e=r.Util.colorToRGBA("#"+t)),e?r.Util._rgbToHex(e.r,e.g,e.b).replace("#","").toLowerCase():t.replace("#","").toLowerCase()||"000000"};let l=null;export function getPptxGen(){return window.PptxGenJS?Promise.resolve(window.PptxGenJS):l||(l=new Promise(t=>{var e=document.createElement("script");e.onload=function(){t(window.PptxGenJS)},e.src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs/dist/pptxgen.bundle.js",document.head.appendChild(e)}),l)}const g=async({element:o,slide:i})=>{let{src:n}=o;if("svg"===o.type&&Object.keys(o.colorsReplace).length){const t=await a.urlToString(n);n=a.replaceColors(t,new Map(Object.entries(o.colorsReplace)))}const r=await t(n),l=r.width*o.cropWidth,g=r.height*o.cropHeight,p=o.width/o.height;let w,u;const f=l/g;"svg"===o.type?(w=l,u=g):p>=f?(w=l,u=l/p):(w=g*p,u=g);let m=await e(n,Object.assign(Object.assign({},o),{cropWidth:w/r.width,cropHeight:u/r.height}));(o.cornerRadius||o.borderSize)&&(m=await(async(e,{width:a,height:o,cornerRadius:i,borderSize:n,borderColor:r})=>{if(!i&&!n){return e}const s=await t(e),d=document.createElement("canvas");d.width=Math.max(1,Math.round(a)),d.height=Math.max(1,Math.round(o));const c=d.getContext("2d"),l=Math.max(0,i),g=d.width,p=d.height,w=(t=!1)=>{const e=Math.min(l,Math.min(g,p)/2);c.beginPath(),c.moveTo(e,0),c.lineTo(g-e,0),c.quadraticCurveTo(g,0,g,e),c.lineTo(g,p-e),c.quadraticCurveTo(g,p,g-e,p),c.lineTo(e,p),c.quadraticCurveTo(0,p,0,p-e),c.lineTo(0,e),c.quadraticCurveTo(0,0,e,0),c.closePath(),t&&n>0&&(c.lineWidth=n,c.strokeStyle="#"+h(r),c.stroke())};return w(!1),c.save(),c.clip(),c.drawImage(s,0,0,g,p),c.restore(),n>0&&w(!0),d.toDataURL("image/png")})(m,{width:o.width,height:o.height,cornerRadius:o.cornerRadius,borderSize:o.borderSize,borderColor:o.borderColor}));const b=Object.assign(Object.assign({},c(o)),{w:s(o.width),h:s(o.height),rotate:o.rotation,flipH:o.flipX,flipV:o.flipY,transparency:d(o.opacity)});if(o.shadowEnabled){const t=Math.hypot(o.shadowOffsetX,o.shadowOffsetY)/2,e=180*Math.atan2(o.shadowOffsetY,o.shadowOffsetX)/Math.PI;b.shadow={type:"outer",blur:o.shadowBlur/2,offset:t,angle:e,color:h(o.shadowColor),opacity:o.shadowOpacity}}await i.addImage(Object.assign({path:m},b))},p=t=>"arrow"===t?"arrow":"triangle"===t?"triangle":"circle"===t?"oval":"square"===t?"diamond":"none",w=t=>{if(t&&t.length){return t.length<=2?"dash":"dashDot"}},u={image:g,svg:g,gif:g,text:async({element:t,slide:e})=>{let a=i(t.text||"");"uppercase"===t.textTransform&&(a=a.toUpperCase());const o=Object.assign(Object.assign(Object.assign(Object.assign({},c(t)),{w:s(t.width),h:s(t.height),fontSize:Math.round(.75*t.fontSize),fontFace:t.fontFamily,color:h(t.fill),align:t.align,bold:"bold"===t.fontWeight,italic:"italic"===t.fontStyle}),"underline"===t.textDecoration?{underline:{style:"sng",color:h(t.fill)}}:{}),{lineSpacingMultiple:t.lineHeight,rotate:t.rotation,fit:"shrink",transparency:d(t.opacity),margin:0});if("middle"===t.verticalAlign?o.valign="middle":"bottom"===t.verticalAlign?o.valign="bottom":o.valign="top",t.letterSpacing&&(o.charSpacing=t.letterSpacing*o.fontSize),t.strokeWidth>0&&(o.outline={size:.75*t.strokeWidth,color:h(t.stroke)}),t.shadowEnabled){const e=.75*Math.hypot(t.shadowOffsetX,t.shadowOffsetY)/2,a=180*Math.atan2(t.shadowOffsetY,t.shadowOffsetX)/Math.PI;o.shadow={type:"outer",blur:.75*t.shadowBlur,offset:e,angle:a,color:h(t.shadowColor),opacity:t.shadowOpacity}}if(t.backgroundEnabled){o.fill={color:h(t.backgroundColor)};const e=t.backgroundCornerRadius*(t.fontSize*t.lineHeight*.5);o.rectRadius=s(e);const a=t.backgroundPadding*(t.fontSize*t.lineHeight);o.margin=Math.max(0,Math.round(.75*a))}await e.addText(a,o)},line:async({element:t,slide:e})=>{const a=Object.assign(Object.assign({},c(t)),{w:s(t.width),h:s(t.height),line:{color:h(t.color),width:t.height,beginArrowType:p(t.startHead),endArrowType:p(t.endHead),dashType:w(t.dash),transparency:d(t.opacity)},rotate:t.rotation,transparency:d(t.opacity)});await e.addShape("line",a)},figure:async({element:e,slide:a})=>{const i=o(e),n=await(async(e,a,o)=>{const i="data:image/svg+xml;base64,"+btoa(e),n=await t(i),r=document.createElement("canvas");return r.width=Math.max(1,Math.round(a)),r.height=Math.max(1,Math.round(o)),r.getContext("2d").drawImage(n,0,0,r.width,r.height),r.toDataURL("image/png")})(i,e.width,e.height),r=Object.assign(Object.assign({},c(e)),{w:s(e.width),h:s(e.height),rotate:e.rotation,transparency:d(e.opacity)});await a.addImage(Object.assign({path:n},r))},group:async({element:t,slide:e})=>{for(const a of t.children||[]){await f({element:a,slide:e})}},video:async({element:t,slide:e})=>{const a=Object.assign(Object.assign({},c(t)),{w:s(t.width),h:s(t.height),rotate:t.rotation});await e.addMedia(Object.assign({type:"video",path:t.src},a))}},f=async({element:t,slide:e})=>{if(!t.visible||!t.showInExport){return}const a=u[t.type];a?await a({element:t,slide:e}):console.warn(`PPTX export doesn't support ${t.type} type`)};export async function jsonToPPTX({json:t}){const e=new(await getPptxGen());e.defineLayout({name:"CUSTOM",width:s(t.width),height:s(t.height)}),e.layout="CUSTOM";for(const a of t.pages){const t=e.addSlide();if(/\.(jpg|jpeg|png|gif)$/i.test(a.background)||a.background.startsWith("data:image")||a.background.startsWith("http")){await t.addImage({path:a.background,x:0,y:0,w:e.width,h:e.height,sizing:{type:"contain"}})}else{const e=r.Util.colorToRGBA(a.background),o=r.Util._rgbToHex(e.r,e.g,e.b).replace("#","");t.background={color:o}}for(const e of a.children){await f({element:e,slide:t})}}return e.writeFile("test.pptx"),e}