var e=this&&this.__rest||function(e,t){var n={};for(var r in e){Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r])}if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++){t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}}return n};import{cropImage as t,getCrop as n,loadImage as r}from"./image.js";import*as i from"./svg.js";import{injectGoogleFont as o,injectCustomFont as a,loadFont as s}from"./fonts.js";import{figureToSvg as l}from"./figure-to-svg.js";import{Effects as h,shapeFilterToCSS as c}from"./filters.js";import{removeTags as g}from"./text.js";export const forEveryChild=(e,t)=>{if(e.children){for(const n of e.children){if(!0===t(n)){break}forEveryChild(n,t)}}};const p=(e,t,...n)=>({type:e,props:t,children:n||[]});export function fixRatio(e){var t=(new DOMParser).parseFromString(e,"image/svg+xml");return t.documentElement.setAttribute("preserveAspectRatio","none"),(new XMLSerializer).serializeToString(t)}const f=async e=>{try{const t=await fetch(e);if("undefined"!=typeof Buffer){const e=await t.arrayBuffer(),n=Buffer.from(e).toString("base64");return`data:${t.headers.get("content-type")||"image/png"};base64,${n}`}{const e=await t.blob();return new Promise((t,n)=>{const r=new FileReader;r.onloadend=()=>t(r.result),r.onerror=n,r.readAsDataURL(e)})}}catch(t){return console.error("Error converting URL to data URL:",t),e}},m=async({element:e,page:t,store:n})=>{let{src:o}=e;if("svg"===e.type){const t=await i.urlToString(o);o=i.replaceColors(t,new Map(Object.entries(e.colorsReplace)))}else{o=await f(o)}let a,s,l,h,c="";e.flipX&&(c+="scaleX(-1)"),e.flipY&&(c+="scaleY(-1)"),e.clipSrc&&(a=`clip-img-mask-${e.id}`,s=await f(e.clipSrc)),e.maskSrc&&(l=`mask-img-${e.id}`,h=await f(e.maskSrc));const g=await r(o),m=g.width*e.cropWidth,d=g.height*e.cropHeight,u=e.width/e.height;let y,w;const $=m/d;"svg"===e.type?(y=m,w=d):u>=$?(y=m,w=m/u):(y=d*u,w=d);const b=y/g.width,x=w/g.height,k=y/w>e.width/e.height?e.height/w:e.width/y,v=y*k/b,j=w*k/x,O=e.cropX*g.width*k,S=e.cropY*g.height*k,H=`clip-${e.id}`,E=o.replace(/&/g,"&amp;"),L={x:-O,y:-S,width:v,height:j,preserveAspectRatio:"none","clip-path":`url(#${H})`},M=[p("clipPath",{id:H},p("rect",{x:0,y:0,width:e.width,height:e.height}))];a&&s&&M.push(p("mask",{id:a,maskUnits:"userSpaceOnUse","mask-type":"alpha"},p("image",{href:s.replace(/&/g,"&amp;"),x:0,y:0,width:e.width,height:e.height,preserveAspectRatio:"none"}))),l&&M.push(p("mask",{id:l,maskUnits:"userSpaceOnUse","mask-type":"alpha"},p("image",Object.assign({href:E},L))));let R=E;const T={};l&&h&&(R=h.replace(/&/g,"&amp;"),T.mask=`url(#${l})`);const P={style:{transform:c}};return a&&(P.mask=`url(#${a})`),p("g",P,p("defs",{},...M),p("image",Object.assign(Object.assign({href:R},L),T)))},d=({element:e,type:t})=>{const n={"stroke-width":e.height,stroke:e.color,"line-cap":"round","stroke-linejoin":"round",fill:e.color};return"arrow"===t?p("polyline",Object.assign({points:`${3*e.height},${2*-e.height} 0,0 ${3*e.height},${2*e.height}`},n)):"triangle"===t?p("polygon",Object.assign({points:`${3*e.height},${2*-e.height} 0,0 ${3*e.height},${2*e.height}`},n)):"bar"===t?p("polyline",Object.assign({points:`0,${2*-e.height} 0,${2*e.height}`},n)):"circle"===t?p("circle",Object.assign({cx:2*e.height,cy:0,r:2*e.height},n)):"square"===t?p("polygon",Object.assign({points:`0,${2*-e.height} ${4*e.height},${2*-e.height} ${4*e.height},${2*e.height} 0,${2*e.height}`},n)):null},u={image:m,svg:m,text:async({element:e,page:t,store:n})=>{const r=(e,t,n,r,i,o=0)=>{const a=document.createElement("canvas").getContext("2d");return a.font=`${i} ${r} ${t}px ${n}`,a.measureText(e).width+Math.max(0,(e?e.length:0)-1)*o*t},i=(e,t,n,i,o,a,s=0)=>{const l=[];return e.split("\n").forEach(e=>{const h=e.split(" ");let c="";for(let g=0;g<h.length;g++){const e=c+h[g]+" ";r(e,n,i,o,a,s)>t+.5&&g>0?(l.push(c.trim()),c=h[g]+" "):c=e}l.push(c.trim())}),l};let o=g(e.text);"uppercase"==e.textTransform&&(o=o.toUpperCase());let a=e.fontSize,s=[];for(;;){s=i(o,e.width,a,e.fontFamily,e.fontWeight,e.fontStyle,e.letterSpacing);const t=Math.max(...s.map(t=>r(t,a,e.fontFamily,e.fontWeight,e.fontStyle,e.letterSpacing))),n=s.length*a*e.lineHeight;if(t<=e.width&&n<=e.height){break}if(a-=1,a<4){break}}const l=a*e.lineHeight,h=s.length*l;let c=a;"middle"===e.verticalAlign?c=(e.height-h)/2+a:"bottom"===e.verticalAlign&&(c=e.height-h+a);const f="center"===e.align?"middle":"right"===e.align?"end":"start",m=s.map((t,n)=>p("tspan",{x:"center"===e.align?e.width/2:"right"===e.align?e.width:0,dy:0===n?0:l,innerHTML:t}));return p("g",{},p("text",{fill:e.fill,y:c,"font-size":a+"px","text-anchor":f,"font-family":e.fontFamily,"font-style":e.fontStyle,"font-weight":e.fontWeight,"text-decoration":e.textDecoration,"line-height":e.lineHeight,"letter-spacing":e.letterSpacing+"em","stroke-width":e.strokeWidth,stroke:e.stroke},...m))},line:async({element:e,page:t,store:n})=>p("g",{},p("line",{x1:0,y1:e.height/2,x2:e.width,y2:e.height/2,stroke:e.color,"stroke-width":e.height,"stroke-dasharray":e.dash&&e.dash.length?e.dash.map(t=>t*e.height).join(" "):void 0}),p("g",{transform:`translate(0 ${e.height/2})`},d({element:e,type:e.startHead})),p("g",{transform:`translate(${e.width} ${e.height/2}) rotate(180)`},d({element:e,type:e.endHead}))),figure:async({element:e,page:t,store:n,elementHook:r})=>{const i=function(e){let t=e.replace(/<svg[^>]*>/,"");return t=t.replace(/<\/svg>/,""),t}(l(e)),o=p("g",{innerHTML:i});return r&&r({dom:o,element:e})||o},group:async({element:e,page:t,store:n,elementHook:r})=>{const i=await Promise.all(e.children.map(e=>y({element:e,page:t,store:n,elementHook:r}))),o=p("g",{style:{"transform-origin":"top left"}},...i);return r&&r({dom:o,element:e})||o},gif:m};async function y({element:e,page:t,store:n,elementHook:r}){var i;let o=await u[e.type];o||(o=()=>p("g",{}),console.error(`SVG export does not support ${e.type} type...`));const a=await o({element:e,page:t,store:n}),s=[],l=[];if(e.blurEnabled&&s.push(`blur(${e.blurRadius/2}px)`),e.brightnessEnabled&&s.push(`brightness(${100*e.brightness+100}%)`),e.sepiaEnabled&&s.push("sepia()"),e.grayscaleEnabled&&s.push("grayscale()"),e.shadowEnabled&&s.push(`drop-shadow(${e.shadowOffsetX}px ${e.shadowOffsetY}px ${e.shadowBlur}px ${e.shadowColor})`),e.filters){for(const[p,f]of Object.entries(e.filters)){const e=c(h[p],f.intensity);if(e&&(s.push(e.filter),e.html)){const t=e.html.replace(/<svg([^>]*)>/,"<g$1>").replace(/<\/svg>/,"</g>");l.push(t)}}}const g=p("g",{className:"element",id:e.id,transform:"group"!==e.type?`translate(${e.x}, ${e.y}) rotate(${e.rotation})`:void 0,display:null===(i=e.visible)||void 0===i||i?void 0:"none",opacity:e.opacity,style:{"transform-origin":"top left",filter:s.join(" ")}},a,...l);return r&&r({dom:g,element:e})||g}async function w(e){try{const t=await fetch(e),n=t.headers.get("content-type")||"font/ttf",r=await t.arrayBuffer();return`data:${n};base64,${"undefined"!=typeof Buffer?Buffer.from(r).toString("base64"):function(e){const t=new Uint8Array(e);let n="";for(let r=0;r<t.length;r+=32768){const e=t.subarray(r,r+32768);n+=String.fromCharCode(...e)}if("undefined"!=typeof btoa){return btoa(n)}if("undefined"!=typeof Buffer){return Buffer.from(t).toString("base64")}throw new Error("No base64 encoder available in this environment")}(r)}`}catch(t){return console.error("Error embedding font:",t),e}}export async function jsonToDOM({json:e,elementHook:i}){const l=[];forEveryChild({children:e.pages},e=>{"text"===e.type&&-1===l.indexOf(e.fontFamily)&&l.push(e.fontFamily)});const h=await async function(e,t){return await Promise.all(e.map(async e=>{var n,r;if("Arial"===e){return null}const i=t.find(t=>t.fontFamily===e);if(i){a(i),await s(e,"normal","normal"),await s(e,"normal","bold"),await s(e,"normal","italic"),await s(e,"normal","bold-italic");const t=await w(i.url);return p("style",{},`@font-face { font-family: ${e}; src: url(${t}); }`)}{o(e),await s(e,"normal","normal");const t=`https://fonts.googleapis.com/css?family=${e}:bi,normal,i,b`;try{const i=await fetch(t),o=await i.text(),a=null===(r=null===(n=o.match(/url\((.*?)\)/g))||void 0===n?void 0:n.map(e=>e.replace(/url\((.*?)\)/,"$1")))||void 0===r?void 0:r.filter(e=>e.startsWith("https"));if(!(null==a?void 0:a.length)){throw new Error("No font URLs found")}const s=await Promise.all(a.map(async t=>{const n=await w(t),r=o.match(/font-style:\s*(.*?);/),i=o.match(/font-weight:\s*(.*?);/),a=r?r[1]:"normal",s=i?i[1]:"normal";return`@font-face {\n                font-family: ${e};\n                font-style: ${a};\n                font-weight: ${s};\n                src: url(${n});\n              }`}));return p("style",{},s.join("\n"))}catch(l){return console.error("Error embedding Google Font:",l),p("defs",{},p("style",{type:"text/css",innerHTML:`@import url('${t}');`.replace(/&/g,"&amp;")}))}}}))}(l,e.fonts),c=await Promise.all(e.pages.map(o=>async function({page:e,store:i,elementHook:o}){const a=await Promise.all(e.children.map(t=>y({element:t,page:e,store:i,elementHook:o}))),s=e.background.indexOf("url")>=0||e.background.indexOf("http")>=0||e.background.indexOf(".jpg")>=0||e.background.indexOf(".png")>=0||e.background.indexOf(".jpeg")>=0;let l;if(s){const o=await r(e.background);l=await t(e.background,Object.assign({width:i.width,height:i.height,x:0,y:0},n({width:i.width,height:i.height},{width:o.width,height:o.height})))}return p("g",{className:"page",style:{}},s?p("image",{"xlink:href":l,x:0,y:0,width:i.width,height:i.height,preserveAspectRatio:"none"}):p("rect",{x:0,y:0,width:i.width,height:i.height,fill:s?void 0:e.background}),...a)}({page:o,store:e,elementHook:i})));return p("svg",{xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:`0 0 ${e.width} ${e.height}`,width:e.width,height:e.height},...h,...c)}const $=({dom:t,nestLevel:n=0})=>{if("string"==typeof t){return t}if(!t){return""}const r=t.props,{innerHTML:i}=r,o=e(r,["innerHTML"]),a=" ".repeat(n);return`${a}<${t.type} ${Object.keys(o).map(e=>((e,t)=>"object"==typeof t?`${e}="${Object.keys(t).map(e=>`${e}:${t[e]};`).join(" ")}"`:null==t||""===t?"":`${e}="${t}"`)(e,o[e])).join(" ")}>${i||"\n"+t.children.map(e=>$({dom:e,nestLevel:n+1})).join("")}${a}</${t.type}>\n`};export async function jsonToSVG({json:e,elementHook:t}){const n=await jsonToDOM({json:e,elementHook:t});return $({dom:n})}